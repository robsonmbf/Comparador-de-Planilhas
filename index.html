<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparador de Planilhas (React)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS (xlsx) para ler planilhas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- React e ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel para transpilar JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            transition: background-color 0.3s, color 0.3s;
        }
        .detail-view {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .detail-view.open {
            max-height: 20000px; /* Um valor alto para permitir a expansão */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useCallback, useEffect, useRef } = React;

        // A versão da aplicação, usada para controlar a exibição das notas de atualização.
        const APP_VERSION = "6.1";

        // --- Ícones em SVG ---
        const ThemeToggleIcon = ({ theme }) => (
            theme === 'dark' ? (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-yellow-400"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
            ) : (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-gray-600"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            )
        );
        
        const TrashIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
        );

        // --- Componentes da UI ---
        const Header = ({ theme }) => (
            <div className="text-center mb-8">
                <h1 className={`text-3xl md:text-4xl font-bold ${theme === 'dark' ? 'text-white' : 'text-gray-900'}`}>Verificador de Planilhas</h1>
                <p className={`${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'} mt-2`}>Compare ou gere planilhas de funcionários de forma inteligente.</p>
            </div>
        );

        const Notice = ({ theme }) => (
            <div className={`${theme === 'dark' ? 'bg-gray-900 border-blue-500' : 'bg-blue-50 border-blue-400'} border-l-4 p-4 rounded-lg mb-8 text-sm`}>
                <p className={`font-bold ${theme === 'dark' ? 'text-white' : 'text-gray-800'}`}>Dicas:</p>
                <ul className={`list-disc list-inside mt-2 space-y-1 ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}`}>
                    <li>Antes de realizar a importação verifique se está logado na empresa correta.</li>
                    <li>Orientamos que sejam realizados testes com poucos dados, principalmente se a planilha conter diversas alterações.</li>
                </ul>
                <p className={`mt-4 ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}><strong className="font-semibold">Obs:</strong> Se a planilha apresentar mais de 200 registros, será gerado um Pedido de Processamento.</p>
            </div>
        );

        const FileInput = ({ id, label, onFileSelect, fileInfo, theme }) => (
            <div>
                <div className="flex justify-between items-center mb-2">
                    <label htmlFor={id} className={`block text-sm font-medium ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}`}>{label}</label>
                    {fileInfo && <span className={`text-sm font-medium ${fileInfo.error ? (theme === 'dark' ? 'text-red-400' : 'text-red-600') : (theme === 'dark' ? 'text-green-400' : 'text-green-600')}`}>{fileInfo.message}</span>}
                </div>
                <input
                    type="file"
                    id={id}
                    accept=".xlsx, .xls, .csv"
                    onChange={(e) => onFileSelect(e.target.files[0])}
                    className={`block w-full text-sm ${theme === 'dark' ? 'text-gray-400 file:bg-gray-600 file:text-gray-200 hover:file:bg-gray-500' : 'text-gray-500 file:bg-gray-100 file:text-gray-800 hover:file:bg-gray-200'} file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold cursor-pointer`}
                />
            </div>
        );

        const Loader = ({ text, theme }) => (
            <div className="flex justify-center items-center my-6">
                <div className={`w-10 h-10 border-4 ${theme === 'dark' ? 'border-gray-600' : 'border-gray-200'} border-t-blue-500 rounded-full animate-spin`}></div>
                <p className={`ml-4 ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>{text}</p>
            </div>
        );
        
        const ResultSection = ({ title, count, children, theme, isOpen, onToggle, color = 'blue' }) => {
            if (count === 0) return null;

            const colorClasses = {
                red: 'border-red-500/50',
                green: 'border-green-500/50',
                purple: 'border-purple-500/50',
                yellow: 'border-yellow-500/50',
                blue: 'border-blue-500/50',
            };

            const badgeColorClasses = {
                red: theme === 'dark' ? 'bg-red-900 text-red-300' : 'bg-red-100 text-red-800',
                green: theme === 'dark' ? 'bg-green-900 text-green-300' : 'bg-green-100 text-green-800',
                purple: theme === 'dark' ? 'bg-purple-900 text-purple-300' : 'bg-purple-100 text-purple-800',
                yellow: theme === 'dark' ? 'bg-yellow-900 text-yellow-300' : 'bg-yellow-100 text-yellow-800',
                blue: theme === 'dark' ? 'bg-blue-900 text-blue-300' : 'bg-blue-100 text-blue-800',
            };

            return (
                <div className={`border-l-4 rounded-r-lg mb-4 ${colorClasses[color]} ${theme === 'dark' ? 'bg-gray-800' : 'bg-white'}`}>
                    <button
                        onClick={onToggle}
                        className="w-full flex justify-between items-center p-4 text-left"
                    >
                        <span className={`font-bold text-lg ${theme === 'dark' ? 'text-white' : 'text-gray-900'}`}>{title}</span>
                        <div className="flex items-center">
                            <span className={`mr-4 px-3 py-1 text-sm font-bold rounded-full ${badgeColorClasses[color]}`}>{count}</span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`transition-transform duration-300 ${isOpen ? 'rotate-180' : ''}`}>
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </div>
                    </button>
                    <div className={`detail-view ${isOpen ? 'open' : ''}`}>
                        <div className="p-4 border-t border-gray-500/30">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        // --- Mapeamento e Funções Utilitárias ---
        const systemColumns = {
            cpf: { label: 'CPF', variations: ['CPF'] },
            nome: { label: 'Nome', variations: ['Nome Funcionário', 'Nome', 'NOME DO FUNCIONÁRIO', 'NOME COMPLETO'] },
            dataNascimento: { label: 'Data de Nascimento', variations: ['Data de Nascimento', 'Dt.Nascimento', 'DATA NASCIMENTO'] },
            dataAdmissao: { label: 'Data de Admissão', variations: ['Data de Admissão', 'Dt.Admissão', 'DATA ADMISSAO'] },
            dataDemissao: { label: 'Data de Demissão', variations: ['Data de Demissão', 'Dt.Demissão', 'DATA DEMISSAO'], required: false },
            situacao: { label: 'Situação', variations: ['Situação'], required: false },
            sexo: { label: 'Sexo', variations: ['Sexo'], required: false },
            matricula: { label: 'Matrícula', variations: ['Matrícula', 'MATRICULA e-SOCIAL DO FUNCIONÁRIO', 'MATRICULA'] },
            codFuncionario: { label: 'Cód. Funcionário', variations: ['Cod Funcionário', 'Cód. Funcionário', 'Código do Funcionário'], required: false },
            nomeCargo: { label: 'Cargo', variations: ['Cargo', 'Nome Cargo', 'Função', 'CARGO/ FUNÇÃO DE ACORDO COM e-SOCIAL'] },
            nomeSetor: { label: 'Setor', variations: ['Setor', 'Nome Setor', 'Departamento'] }
        };

        const findColumnValue = (row, columnMap, systemKey) => {
            const headerName = columnMap[systemKey];
            return headerName ? row[headerName] : undefined;
        };
        
        const normalizeCpf = (cpfValue) => {
            if (cpfValue === null || typeof cpfValue === 'undefined') return '';
            let cpfString = String(cpfValue).replace(/\D/g, '');
            while (cpfString.length > 0 && cpfString.length < 11) {
                cpfString = '0' + cpfString;
            }
            return cpfString;
        };

        const formatCpf = (cpf) => {
            const cpfString = String(cpf || '').replace(/\D/g, '');
            if (cpfString.length === 11) {
                return cpfString.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
            }
            return cpf;
        }

        const normalizeName = (nameValue) => {
            if (nameValue === null || typeof nameValue === 'undefined') return '';
            return String(nameValue)
                .toLowerCase()
                .trim()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .replace(/z/g, 's');
        };

        const normalizeValue = (value) => {
            if (value === null || typeof value === 'undefined') return '';
            if (value instanceof Date) {
                const adjustedDate = new Date(value.getTime() + Math.abs(value.getTimezoneOffset() * 60000));
                return `${String(adjustedDate.getUTCDate()).padStart(2, '0')}/${String(adjustedDate.getUTCMonth() + 1).padStart(2, '0')}/${adjustedDate.getUTCFullYear()}`;
            }
            const stringValue = String(value).trim();
            const dateMatch = stringValue.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/);
            if (dateMatch) {
                return `${dateMatch[1].padStart(2, '0')}/${dateMatch[2].padStart(2, '0')}/${dateMatch[3]}`;
            }
            return stringValue;
        };
        
        const formatTitleCase = (str) => {
            if (!str || typeof str !== 'string') return '';
            const exceptions = ['da', 'de', 'do', 'dos', 'das', 'em'];
            let formattedStr = str.toLowerCase().replace(/\s+/g, ' ').trim();
            formattedStr = [...new Set(formattedStr.split(' '))].join(' ');
            return formattedStr
                .split(' ')
                .map(word => exceptions.includes(word) ? word : word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        };

        const getCpfInvalidityReason = (originalCpf) => {
            const normalized = normalizeCpf(originalCpf);
            if (!normalized) return "CPF em branco";
            if (normalized.length !== 11) return `Contém ${normalized.length} dígitos (esperado 11)`;
            return null;
        };

        const standardizeData = (data, columnMap) => data.map(row => ({
            cpf: findColumnValue(row, columnMap, 'cpf'),
            nome: findColumnValue(row, columnMap, 'nome'),
            dataNascimento: findColumnValue(row, columnMap, 'dataNascimento'),
            dataAdmissao: findColumnValue(row, columnMap, 'dataAdmissao'),
            dataDemissao: findColumnValue(row, columnMap, 'dataDemissao'),
            situacao: findColumnValue(row, columnMap, 'situacao'),
            sexo: findColumnValue(row, columnMap, 'sexo'),
            matricula: findColumnValue(row, columnMap, 'matricula'),
            codFuncionario: findColumnValue(row, columnMap, 'codFuncionario'),
            nomeCargo: findColumnValue(row, columnMap, 'nomeCargo'),
            nomeSetor: findColumnValue(row, columnMap, 'nomeSetor'),
        }));
        
        const parseDate = (dateString) => {
            if (!dateString || typeof dateString !== 'string') return null;
            const parts = dateString.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/);
            if (!parts) return null;
            return new Date(parts[3], parts[2] - 1, parts[1]);
        };

        // --- Novos Componentes ---
        const UpdateNotesModal = ({ isOpen, onClose, theme }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className={`w-full max-w-lg rounded-lg shadow-2xl ${theme === 'dark' ? 'bg-gray-800 border border-gray-700' : 'bg-white'}`}>
                        <div className={`p-4 border-b ${theme === 'dark' ? 'border-gray-700' : 'border-gray-200'} flex justify-between items-center`}>
                            <h3 className={`font-bold text-lg ${theme === 'dark' ? 'text-white' : 'text-gray-900'}`}>Novidades da Versão {APP_VERSION}</h3>
                            <button onClick={onClose} className={`${theme === 'dark' ? 'text-gray-400 hover:text-white' : 'text-gray-500 hover:text-gray-800'}`}>&times;</button>
                        </div>
                        <div className="p-6 space-y-4 text-sm max-h-[70vh] overflow-y-auto">
                            <div>
                                <p className="font-semibold text-blue-400">O que há de novo?</p>
                                <ul className="list-disc list-inside space-y-2 mt-2">
                                    <li><strong className="text-green-400">Mapeamento Manual de Colunas:</strong> Adicionada a opção de digitar o nome da coluna manualmente caso não esteja na lista.</li>
                                    <li><strong className="text-green-400">Funcionalidade "Gerar Modelo SOC" Restaurada:</strong> A ferramenta para gerar um novo modelo de importação a partir de uma planilha do cliente está de volta e totalmente funcional.</li>
                                </ul>
                            </div>
                        </div>
                        <div className={`p-4 border-t ${theme === 'dark' ? 'border-gray-700' : 'border-gray-200'} text-right`}>
                            <button onClick={onClose} className="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Entendido</button>
                        </div>
                    </div>
                </div>
            )
        };
        
        const ColumnMappingModal = ({ isOpen, onClose, onConfirm, fileHeaders, theme, fileName }) => {
            const [mapping, setMapping] = useState({});

            useEffect(() => {
                if (isOpen) {
                    const initialMap = {};
                    for (const key in systemColumns) {
                        const variations = systemColumns[key].variations.map(v => v.toLowerCase());
                        const foundHeader = fileHeaders.find(h => variations.includes(h.toLowerCase()));
                        initialMap[key] = foundHeader || '';
                    }
                    setMapping(initialMap);
                }
            }, [isOpen, fileHeaders]);

            if (!isOpen) return null;

            const handleInputChange = (systemKey, value) => {
                setMapping(prev => ({ ...prev, [systemKey]: value }));
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
                    <div className={`w-full max-w-3xl rounded-lg shadow-2xl ${theme === 'dark' ? 'bg-gray-800 border border-gray-700' : 'bg-white'}`}>
                        <div className={`p-4 border-b ${theme === 'dark' ? 'border-gray-700' : 'border-gray-200'}`}>
                            <h3 className={`font-bold text-lg ${theme === 'dark' ? 'text-white' : 'text-gray-900'}`}>Mapear Colunas</h3>
                            <p className={`text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>Associe ou digite o nome da coluna do seu arquivo: <strong>{fileName}</strong></p>
                        </div>
                        <div className="p-6 grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 max-h-[60vh] overflow-y-auto">
                            {Object.entries(systemColumns).map(([key, { label }]) => (
                                <div key={key}>
                                    <label className={`block text-sm font-medium mb-1 ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}`}>{label}</label>
                                    <div className="flex items-center space-x-2">
                                        <select
                                            value={fileHeaders.includes(mapping[key]) ? mapping[key] : ''}
                                            onChange={(e) => handleInputChange(key, e.target.value)}
                                            className={`w-1/2 p-2 rounded-lg border text-sm ${theme === 'dark' ? 'bg-gray-600 border-gray-500 text-white' : 'bg-white border-gray-300 text-black'}`}
                                        >
                                            <option value="">-- Selecione --</option>
                                            {fileHeaders.map(header => <option key={header} value={header}>{header}</option>)}
                                        </select>
                                        <input
                                            type="text"
                                            value={mapping[key] || ''}
                                            onChange={(e) => handleInputChange(key, e.target.value)}
                                            placeholder="Ou digite aqui"
                                            className={`w-1/2 p-2 rounded-lg border text-sm ${theme === 'dark' ? 'bg-gray-700 border-gray-500 text-white' : 'bg-gray-50 border-gray-300 text-black'}`}
                                        />
                                    </div>
                                </div>
                            ))}
                        </div>
                        <div className={`p-4 border-t ${theme === 'dark' ? 'border-gray-700' : 'border-gray-200'} flex justify-end space-x-4`}>
                            <button onClick={onClose} className={`font-bold py-2 px-4 rounded-lg transition-colors ${theme === 'dark' ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'}`}>Cancelar</button>
                            <button onClick={() => onConfirm(mapping)} className="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Confirmar Mapeamento</button>
                        </div>
                    </div>
                </div>
            );
        };
        
        const MissingDataModal = ({ isOpen, onClose, onConfirm, missingData, theme }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className={`w-full max-w-xl rounded-lg shadow-2xl ${theme === 'dark' ? 'bg-gray-800 border border-gray-700' : 'bg-white'}`}>
                        <div className={`p-4 border-b ${theme === 'dark' ? 'border-gray-700' : 'border-gray-200'}`}>
                            <h3 className={`font-bold text-lg ${theme === 'dark' ? 'text-white' : 'text-gray-900'}`}>Dados Obrigatórios Faltando</h3>
                        </div>
                        <div className="p-6 text-sm">
                            <p className={`${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'} mb-4`}>
                                Foram encontrados funcionários com informações essenciais faltando. Você pode cancelar para corrigir a planilha original ou gerar um modelo incompleto.
                            </p>
                            <div className={`border rounded-lg p-2 max-h-64 overflow-y-auto ${theme === 'dark' ? 'border-gray-600' : 'border-gray-300'}`}>
                                {missingData.map(emp => (
                                    <div key={emp.index} className={`p-2 ${theme === 'dark' ? 'hover:bg-gray-700' : 'hover:bg-gray-100'} rounded`}>
                                        <p className={`font-semibold ${theme === 'dark' ? 'text-white' : 'text-black'}`}>Linha {emp.index}: {emp.nome || 'Nome não encontrado'}</p>
                                        <p className="text-red-500 text-xs">Faltando: {emp.missing.join(', ')}</p>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div className={`p-4 border-t ${theme === 'dark' ? 'border-gray-700' : 'border-gray-200'} flex justify-end space-x-4`}>
                            <button onClick={onClose} className={`font-bold py-2 px-4 rounded-lg transition-colors ${theme === 'dark' ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'}`}>
                                Cancelar
                            </button>
                            <button onClick={onConfirm} className="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                                Gerar Mesmo Assim
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const StatCard = ({ title, value, color, theme }) => {
            const colorClasses = {
                red: theme === 'dark' ? 'bg-red-900/50 border-red-700' : 'bg-red-50 border-red-400',
                green: theme === 'dark' ? 'bg-green-900/50 border-green-700' : 'bg-green-50 border-green-400',
                yellow: theme === 'dark' ? 'bg-yellow-900/50 border-yellow-700' : 'bg-yellow-50 border-yellow-400',
                blue: theme === 'dark' ? 'bg-blue-900/50 border-blue-700' : 'bg-blue-50 border-blue-400',
            };
            return (
                <div className={`p-4 rounded-lg border ${colorClasses[color]}`}>
                    <p className={`text-sm font-medium ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>{title}</p>
                    <p className={`text-3xl font-bold ${theme === 'dark' ? 'text-white' : 'text-gray-900'}`}>{value}</p>
                </div>
            );
        };

        const ResultsDashboard = ({ results, theme }) => {
            const totalIssues = results.discrepancies.length + results.newEmployees.length + results.removedEmployees.filter(e => e.recommendation === 'inactivate').length;
            const data = [
                { label: 'Divergências', value: results.discrepancies.length, color: 'bg-red-500' },
                { label: 'Novos', value: results.newEmployees.length, color: 'bg-green-500' },
                { label: 'A Inativar', value: results.removedEmployees.filter(e => e.recommendation === 'inactivate').length, color: 'bg-yellow-500' },
            ];

            return (
                <div className={`p-6 rounded-lg mb-8 ${theme === 'dark' ? 'bg-gray-900/50' : 'bg-gray-50'}`}>
                    <h2 className={`text-2xl font-bold mb-4 text-center ${theme === 'dark' ? 'text-white' : 'text-gray-800'}`}>Resumo da Análise</h2>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <StatCard title="Total no SOC" value={results.socData.length} color="blue" theme={theme} />
                        <StatCard title="Total no Cliente" value={results.companyData.length} color="blue" theme={theme} />
                        <StatCard title="Divergências" value={results.discrepancies.length} color="red" theme={theme} />
                        <StatCard title="Novos Funcionários" value={results.newEmployees.length} color="green" theme={theme} />
                    </div>
                    <div>
                        <h3 className={`text-lg font-semibold mb-2 ${theme === 'dark' ? 'text-gray-200' : 'text-gray-700'}`}>Distribuição de Ações</h3>
                        <div className={`w-full rounded-full h-8 flex overflow-hidden ${theme === 'dark' ? 'bg-gray-700' : 'bg-gray-200'}`}>
                            {data.map(item => (
                                totalIssues > 0 && item.value > 0 && (
                                    <div
                                        key={item.label}
                                        className={`h-full ${item.color} flex items-center justify-center text-white text-xs font-bold`}
                                        style={{ width: `${(item.value / totalIssues) * 100}%` }}
                                        title={`${item.label}: ${item.value}`}
                                    >
                                        { (item.value / totalIssues) * 100 > 10 ? item.label : ''}
                                    </div>
                                )
                            ))}
                        </div>
                    </div>
                </div>
            );
        };
        
        // --- Componente Principal ---
        function App() {
            // Estados da aplicação
            const [theme, setTheme] = useState('dark');
            const [mode, setMode] = useState('compare');
            const [openSections, setOpenSections] = useState({}); 
            const [isUpdateModalOpen, setIsUpdateModalOpen] = useState(false);
            
            const [socFile, setSocFile] = useState(null);
            const [companyFile, setCompanyFile] = useState(null);
            const [socFileInfo, setSocFileInfo] = useState(null);
            const [companyFileInfo, setCompanyFileInfo] = useState(null);
            
            const [codUnid, setCodUnid] = useState('');
            const [nomeUnidade, setNomeUnidade] = useState('');
            const [missingDataError, setMissingDataError] = useState(null);
            const [dataForIncompleteGeneration, setDataForIncompleteGeneration] = useState(null);
            
            const [mappingModal, setMappingModal] = useState({ isOpen: false, fileType: null, headers: [], file: null });
            const [socColumnMap, setSocColumnMap] = useState(null);
            const [companyColumnMap, setCompanyColumnMap] = useState(null);

            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState(null);
            const [results, setResults] = useState(null);
            
            useEffect(() => {
                const seenVersion = localStorage.getItem('appVersion');
                if (seenVersion !== APP_VERSION) {
                    setIsUpdateModalOpen(true);
                }
            }, []);

            const handleCloseUpdateModal = () => {
                localStorage.setItem('appVersion', APP_VERSION);
                setIsUpdateModalOpen(false);
            };

            useEffect(() => {
                document.body.className = theme === 'dark' ? 'bg-gray-800 text-gray-200' : 'bg-gray-100 text-gray-800';
            }, [theme]);
            
            const toggleTheme = () => {
                setTheme(prevTheme => prevTheme === 'dark' ? 'light' : 'dark');
            };

            const toggleSection = (sectionName) => {
                setOpenSections(prev => ({...prev, [sectionName]: !prev[sectionName]}));
            };

            const readSheetData = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = new Uint8Array(event.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                            const dataAsArray = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });
                            
                            let headerIndex = -1;
                            const keywords = ['cpf', 'nome', 'nascimento', 'admissão', 'matrícula', 'cargo', 'setor'];
                            for (let i = 0; i < Math.min(dataAsArray.length, 10); i++) {
                                const rowString = dataAsArray[i].join(' ').toLowerCase();
                                if (keywords.filter(k => rowString.includes(k)).length >= 3) {
                                    headerIndex = i;
                                    break;
                                }
                            }

                            if (headerIndex === -1) throw new Error("Cabeçalho não encontrado. Verifique se a planilha contém colunas como CPF, Nome, etc.");
                            
                            const headers = dataAsArray[headerIndex].map(h => String(h).trim()).filter(Boolean);
                            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: headers, range: headerIndex + 1 });

                            resolve({ headers, jsonData });
                        } catch (e) {
                            reject(e);
                        }
                    };
                    reader.onerror = (e) => reject(new Error("Erro ao ler o arquivo."));
                    reader.readAsArrayBuffer(file);
                });
            };

            const handleFileSelect = async (file, fileType) => {
                const setFile = fileType === 'soc' ? setSocFile : setCompanyFile;
                const setInfo = fileType === 'soc' ? setSocFileInfo : setCompanyFileInfo;
                
                setFile(file);
                if (!file) {
                    setInfo(null);
                    if (fileType === 'soc') setSocColumnMap(null);
                    else setCompanyColumnMap(null);
                    return;
                }

                setInfo({ message: 'Lendo...' });
                try {
                    const { headers } = await readSheetData(file);
                    setMappingModal({ isOpen: true, fileType, headers, file });
                } catch (error) {
                    setInfo({ message: 'Erro ao ler cabeçalho', error: true });
                    console.error(`Erro ao ler o arquivo ${fileType}:`, error);
                }
            };
            
            const onMappingConfirm = async (map) => {
                const { fileType, file } = mappingModal;
                const setMap = fileType === 'soc' ? setSocColumnMap : setCompanyColumnMap;
                const setInfo = fileType === 'soc' ? setSocFileInfo : setCompanyFileInfo;

                setMap(map);
                setMappingModal({ isOpen: false, fileType: null, headers: [], file: null });

                try {
                    const { jsonData } = await readSheetData(file);
                    const validData = jsonData.filter(row => getCpfInvalidityReason(findColumnValue(row, map, 'cpf')) === null);
                    setInfo({ message: `${validData.length} funcionários` });
                } catch (error) {
                    setInfo({ message: 'Erro ao processar', error: true });
                }
            };

            const handleCompare = useCallback(async () => {
                setOpenSections({});
                if (!socFile || !companyFile || !socColumnMap || !companyColumnMap) {
                    setError({ title: 'Arquivos ou Mapeamento Faltando', message: 'Por favor, selecione os dois arquivos e confirme o mapeamento de colunas para continuar.' });
                    setResults(null);
                    return;
                }
                
                setIsLoading(true);
                setError(null);
                setResults(null);

                try {
                    const socFileData = await readSheetData(socFile);
                    const companyFileData = await readSheetData(companyFile);
                    
                    const socData = standardizeData(socFileData.jsonData, socColumnMap);
                    const companyData = standardizeData(companyFileData.jsonData, companyColumnMap);
                    
                    const invalidCpfs = [];
                    const filterValidData = (data, source) => data.filter((row, index) => {
                        const reason = getCpfInvalidityReason(row.cpf);
                        if (reason) {
                            invalidCpfs.push({ name: row.nome || `Linha ${index + 2}`, cpf: normalizeValue(row.cpf) || 'Vazio', source, reason });
                            return false;
                        }
                        return true;
                    });

                    const validSocData = filterValidData(socData, 'Planilha SOC');
                    const validCompanyData = filterValidData(companyData, 'Planilha do Cliente');
                    
                    let discrepancies = [], newEmployees = [], socMap = new Map();
                    
                    validSocData.forEach(row => socMap.set(normalizeCpf(row.cpf), row));

                    validCompanyData.forEach(companyRow => {
                        const companyCpf = normalizeCpf(companyRow.cpf);
                        const socRow = socMap.get(companyCpf);

                        if (socRow) {
                            const employeeDiscrepancies = [];
                            const fieldsToCompare = {
                                'Nome': { soc: socRow.nome, comp: companyRow.nome, normalize: normalizeName },
                                'Data de Nascimento': { soc: socRow.dataNascimento, comp: companyRow.dataNascimento, normalize: normalizeValue },
                                'Data de Admissão': { soc: socRow.dataAdmissao, comp: companyRow.dataAdmissao, normalize: normalizeValue },
                                'Matrícula': { soc: socRow.matricula, comp: companyRow.matricula, normalize: normalizeValue },
                            };

                            for (const field in fieldsToCompare) {
                                const { soc, comp, normalize } = fieldsToCompare[field];
                                if (normalize(soc) !== normalize(comp)) {
                                    employeeDiscrepancies.push({ 
                                        field, 
                                        socValue: normalizeValue(soc) || 'Não consta no SOC', 
                                        companyValue: normalizeValue(comp) || 'Não consta na Empresa' 
                                    });
                                }
                            }

                            if (employeeDiscrepancies.length > 0) {
                                discrepancies.push({
                                    cpf: normalizeValue(companyRow.cpf),
                                    name: companyRow.nome || `Funcionário com CPF ${normalizeValue(companyRow.cpf)}`,
                                    details: employeeDiscrepancies
                                });
                            }
                            socMap.delete(companyCpf);
                        } else {
                            newEmployees.push(companyRow);
                        }
                    });
                    
                    const companyAdmissionDates = validCompanyData
                        .map(emp => parseDate(normalizeValue(emp.dataAdmissao)))
                        .filter(date => date && !isNaN(date.getTime()));

                    const maxCompanyAdmissionDate = companyAdmissionDates.length > 0 ? new Date(Math.max.apply(null, companyAdmissionDates)) : null;

                    const removedEmployees = Array.from(socMap.values()).map(emp => {
                        const empAdmissionDateStr = normalizeValue(emp.dataAdmissao);
                        const empAdmissionDate = parseDate(empAdmissionDateStr);

                        let status = 'Ativo no SOC, mas não consta na planilha do Cliente.';
                        let recommendation = 'inactivate';

                        if (normalizeValue(emp.dataDemissao)) {
                            status = `Desligado no SOC (em ${normalizeValue(emp.dataDemissao)}) e não consta na planilha do Cliente.`;
                            recommendation = 'none';
                        } else if (!empAdmissionDate) {
                            status = 'Ativo no SOC, mas a data de admissão não foi encontrada ou está em formato inválido.';
                            recommendation = 'verify';
                        } else if (maxCompanyAdmissionDate && empAdmissionDate > maxCompanyAdmissionDate) {
                            status = `Admissão em ${empAdmissionDateStr}, que é posterior à última admissão da planilha do Cliente.`;
                            recommendation = 'verify';
                        } else {
                            status = `Admitido em ${empAdmissionDateStr}. Ativo no SOC, mas não consta na planilha do Cliente.`;
                            recommendation = 'inactivate';
                        }
                        return { ...emp, status, recommendation };
                    });
                    
                    setResults({ 
                        discrepancies, 
                        newEmployees, 
                        invalidCpfs, 
                        removedEmployees, 
                        socData: validSocData, 
                        companyData: validCompanyData
                    });

                } catch (e) {
                    console.error("Erro na comparação:", e);
                    setError({ title: `Erro ao Processar Arquivo`, message: e.message, suggestion: "Verifique se o arquivo não está corrompido e se o mapeamento das colunas está correto." });
                } finally {
                    setIsLoading(false);
                }
            }, [socFile, companyFile, socColumnMap, companyColumnMap]);

            const handleClear = () => {
                setSocFile(null);
                setCompanyFile(null);
                setSocFileInfo(null);
                setCompanyFileInfo(null);
                setSocColumnMap(null);
                setCompanyColumnMap(null);
                setResults(null);
                setError(null);
                setIsLoading(false);
                setOpenSections({});
                setCodUnid('');
                setNomeUnidade('');
                if (document.getElementById('soc-file')) document.getElementById('soc-file').value = '';
                if (document.getElementById('company-file')) document.getElementById('company-file').value = '';
                if (document.getElementById('company-file-generate')) document.getElementById('company-file-generate').value = '';
            };
            
            const handleDiscrepancyChange = (discrepancyIndex, detailIndex, newValue) => {
                const newResults = { ...results };
                newResults.discrepancies[discrepancyIndex].details[detailIndex].companyValue = newValue;
                setResults(newResults);
            };
            
            const handleExport = async () => {
                 if (!results || !socFile || !socColumnMap) {
                    console.error("Não há dados para exportar.");
                    return;
                }

                const { jsonData: originalSocJson, headers: originalSocHeaders } = await readSheetData(socFile);
                let updatedData = JSON.parse(JSON.stringify(originalSocJson));

                const employeesToInactivate = new Set(
                    results.removedEmployees
                        .filter(emp => emp.recommendation === 'inactivate')
                        .map(emp => normalizeCpf(emp.cpf))
                );
                
                updatedData.forEach(row => {
                    const cpf = normalizeCpf(findColumnValue(row, socColumnMap, 'cpf'));
                    if (employeesToInactivate.has(cpf) && socColumnMap.situacao) {
                        row[socColumnMap.situacao] = 'N';
                    }
                });

                const correctionsMap = new Map();
                results.discrepancies.forEach(disc => {
                    const cpf = normalizeCpf(disc.cpf);
                    const changes = {};
                    disc.details.forEach(detail => {
                        const systemKey = Object.keys(systemColumns).find(key => systemColumns[key].label === detail.field);
                        if (systemKey) {
                            changes[systemKey] = detail.companyValue;
                        }
                    });
                    correctionsMap.set(cpf, changes);
                });

                updatedData.forEach(row => {
                    const cpf = normalizeCpf(findColumnValue(row, socColumnMap, 'cpf'));
                    if (correctionsMap.has(cpf)) {
                        const changes = correctionsMap.get(cpf);
                        for (const key in changes) {
                            if (socColumnMap[key]) {
                                row[socColumnMap[key]] = changes[key];
                            }
                        }
                    }
                });

                results.newEmployees.forEach(newEmp => {
                    const newRow = {};
                    originalSocHeaders.forEach(header => newRow[header] = ''); // Garante todas as colunas originais
                    for (const key in socColumnMap) {
                        if (socColumnMap[key] && newEmp[key] !== undefined) {
                            newRow[socColumnMap[key]] = newEmp[key];
                        }
                    }
                    if(socColumnMap.situacao) newRow[socColumnMap.situacao] = 'S';
                    updatedData.push(newRow);
                });
                
                const worksheet = XLSX.utils.json_to_sheet(updatedData, { header: originalSocHeaders });
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Funcionários Atualizados");
                XLSX.writeFile(workbook, "Planilha_SOC_Atualizada.xlsx");
            };
            
            const proceedWithGeneration = (data) => {
                const modelHeaders = ["Cod.Unid","Nome Unidade","Cod.Setor","Nome Setor","Cod.Cargo","Nome Cargo","Matrícula","Cod Funcionário","Nome Funcionário","Dt.Nascimento","Sexo","Situação","Dt.Admissão","Dt.Demissão","Estado Civil","Pis/Pasep","Contratação","Rg","UF-RG","CPF","CTPS","Endereço","Bairro","Cidade","UF","Cep","Tel","Naturalidade","Cor","E-mail","Deficiencia","CBO","GFIP","Endereço Unidade","Bairro Unidade","Cidade Unidade","Estado Unidade","Cep Unidade","CNPJ Unidade","Inscrição Unidade","Tel1 Unidade","Tel2 Unidade","Tel3 Unidade","Tel4 Unidade","Contato Unid","Cnae","Número Endereço Funcionário","Complemento Endereço Funcionário","Razão Social Unid.","Nome da Mae do Funcionário","Cod.Centro Custo","Dt. Ultima Movimentação","Cod. Unidade contratante","Razão Social","CNPJ","Turno","Dt.Emissão.Cart.Prof","Série CTPS","CNAE 2.0","CNAE Livre","Descrição CNAE Livre","CEI","Função","CNAE 7","Tipo de CNAE Utilizado","Descrição Detalhada do Cargo","Nº endereço Unidade","Complemento endereço Unidade","Regime de Revezamento","Orgão Expedidor do RG","Campo Livre 1","Campo Livre 2","Campo Livre 3","Telefone SMS","Grau de Risco","UF CTPS","Nome Centro Custo","Autoriza SMS","Endereço Cobrança Unidade","Número Endereço Cobrança Unidade","Bairro Cobrança Unidade","Cidade Cobrança Unidade","Estado Cobrança Unidade","Cep Cobrança Unidade","Complemento Endereço Cobrança Unidade","Remuneração Mensal (R$)","Telefone Comercial","Telefone Celular","Data Emissão RG","Código do País de Nascimento","Origem Descrição Detalhada","Unidade Contratante","Escolaridade","Código Categoria (eSocial)","Matrícula RH","Gênero","Nome Social","Tipo de Admissão","Grau de Instrução","Nome do Pai do Funcionário","Tipo de Vínculo","Nome do Turno","Campo Livre 4","CPF Unidade","CAEPF Unidade","Tipo Sanguíneo","Dt. Inicio Periodo Aquisitivo","Dt. Fim Periodo Aquisitivo","CNO Unidade","Desconsiderar para o eSocial","Dt. Validade RG","Desconsiderar Unidade para o eSocial"];
                const outputData = [
                    ['Modelo 1'],
                    modelHeaders,
                    ...data.map((emp, index) => {
                        const row = new Array(modelHeaders.length).fill('');
                        row[0] = codUnid;
                        row[1] = nomeUnidade;
                        row[7] = index + 1;
                        row[8] = emp.nome || '';
                        row[19] = emp.cpf || '';
                        row[9] = emp.dataNascimento || '';
                        row[12] = emp.dataAdmissao || '';
                        row[6] = emp.matricula || '';
                        row[11] = 'S';
                        row[3] = formatTitleCase(emp.nomeSetor);
                        row[5] = formatTitleCase(emp.nomeCargo);
                        row[10] = (emp.sexo && emp.sexo.toUpperCase().startsWith('M')) ? 'M' : (emp.sexo && emp.sexo.toUpperCase().startsWith('F')) ? 'F' : '';
                        return row;
                    })
                ];

                const worksheet = XLSX.utils.aoa_to_sheet(outputData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Modelo SOC Gerado");
                XLSX.writeFile(workbook, "Modelo_SOC_Gerado.xlsx");
            };

            const handleGenerateModel = async () => {
                if (!companyFile || !codUnid || !nomeUnidade || !companyColumnMap) {
                    setError({ title: 'Dados Faltando', message: 'Por favor, preencha o Código e Nome da Unidade, selecione a planilha da empresa e confirme o mapeamento de colunas.' });
                    return;
                }
                setIsLoading(true);
                setError(null);
                try {
                    const { jsonData } = await readSheetData(companyFile);
                    const standardizedData = standardizeData(jsonData, companyColumnMap);

                    const requiredFields = ['nome', 'cpf', 'dataNascimento', 'dataAdmissao', 'matricula', 'nomeCargo', 'nomeSetor'];
                    const employeesWithMissingData = standardizedData.map((emp, index) => {
                        const missing = requiredFields.filter(field => !emp[field]);
                        return { ...emp, missing, index: index + 2 }; // +2 para contar cabeçalho e ser 1-based
                    }).filter(emp => emp.missing.length > 0);

                    if (employeesWithMissingData.length > 0) {
                        setDataForIncompleteGeneration(standardizedData);
                        setMissingDataError(employeesWithMissingData);
                    } else {
                        proceedWithGeneration(standardizedData);
                    }
                } catch (e) {
                     setError({ title: `Erro ao Gerar Modelo`, message: e.message, suggestion: "Verifique o arquivo da empresa e tente novamente." });
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex flex-col items-center p-4">
                    <main className={`relative ${theme === 'dark' ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-200'} rounded-2xl shadow-xl p-6 md:p-10 w-full max-w-6xl border`}>
                        <button onClick={toggleTheme} className="absolute top-4 right-4 p-2 rounded-full bg-gray-500/20 hover:bg-gray-500/40 transition-colors">
                            <ThemeToggleIcon theme={theme} />
                        </button>
                        
                        <Header theme={theme} />

                        <div className={`flex justify-center mb-8 p-1 rounded-lg ${theme === 'dark' ? 'bg-gray-800' : 'bg-gray-200'}`}>
                            <button onClick={() => setMode('compare')} className={`w-1/2 py-2 rounded-md font-semibold transition-colors ${mode === 'compare' ? 'bg-blue-600 text-white' : (theme === 'dark' ? 'hover:bg-gray-700' : 'hover:bg-gray-300')}`}>Comparar Planilhas</button>
                            <button onClick={() => setMode('generate')} className={`w-1/2 py-2 rounded-md font-semibold transition-colors ${mode === 'generate' ? 'bg-blue-600 text-white' : (theme === 'dark' ? 'hover:bg-gray-700' : 'hover:bg-gray-300')}`}>Gerar Modelo SOC</button>
                        </div>
                        
                        {mode === 'compare' ? (
                            <>
                                <Notice theme={theme} />
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                    <FileInput id="soc-file" label="1. Planilha SOC (Exportação de Ativos)" onFileSelect={(file) => handleFileSelect(file, 'soc')} fileInfo={socFileInfo} theme={theme} />
                                    <FileInput id="company-file" label="2. Planilha do Cliente (Relação de Ativos)" onFileSelect={(file) => handleFileSelect(file, 'company')} fileInfo={companyFileInfo} theme={theme} />
                                </div>
                                <div className="text-center">
                                    <button onClick={handleCompare} disabled={isLoading} className="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 disabled:bg-gray-500">
                                        {isLoading ? 'Analisando...' : 'Verificar Dados'}
                                    </button>
                                </div>
                            </>
                        ) : (
                            <>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                    <div>
                                        <label htmlFor="codUnid" className={`block text-sm font-medium ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'} mb-2`}>1. Código da Unidade</label>
                                        <input id="codUnid" type="text" value={codUnid} onChange={(e) => setCodUnid(e.target.value)} className={`w-full p-2 rounded-lg border ${theme === 'dark' ? 'bg-gray-600 border-gray-500' : 'bg-white border-gray-300'}`} />
                                    </div>
                                    <div>
                                        <label htmlFor="nomeUnidade" className={`block text-sm font-medium ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'} mb-2`}>2. Nome da Unidade</label>
                                        <input id="nomeUnidade" type="text" value={nomeUnidade} onChange={(e) => setNomeUnidade(e.target.value)} className={`w-full p-2 rounded-lg border ${theme === 'dark' ? 'bg-gray-600 border-gray-500' : 'bg-white border-gray-300'}`} />
                                    </div>
                                </div>
                                <div className="mb-8">
                                    <FileInput id="company-file-generate" label="3. Planilha do Cliente" onFileSelect={(file) => handleFileSelect(file, 'company')} fileInfo={companyFileInfo} theme={theme} />
                                </div>
                                <div className="text-center">
                                    <button onClick={handleGenerateModel} disabled={isLoading} className="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 disabled:bg-gray-500">
                                        {isLoading ? 'Gerando...' : 'Gerar Modelo SOC'}
                                    </button>
                                </div>
                            </>
                        )}

                        <div className="mt-10">
                            {isLoading && <Loader text="Analisando dados..." theme={theme} />}
                            {error && (
                                <div className={`${theme === 'dark' ? 'bg-red-900/50 border-red-700 text-red-300' : 'bg-red-100 border-red-500 text-red-700'} border p-4 rounded-lg`} role="alert">
                                    <p className="font-bold">{error.title}</p>
                                    <p>{error.message}</p>
                                    {error.suggestion && <p className="mt-2 text-sm"><strong>Sugestão:</strong> {error.suggestion}</p>}
                                </div>
                            )}
                            {results && mode === 'compare' && (
                                <div>
                                    <ResultsDashboard results={results} theme={theme} />

                                    <ResultSection
                                        title="Divergências Encontradas"
                                        count={results.discrepancies.length}
                                        isOpen={openSections['discrepancies']}
                                        onToggle={() => toggleSection('discrepancies')}
                                        theme={theme}
                                        color="red"
                                    >
                                        <div className="space-y-4 max-h-96 overflow-auto">
                                            {results.discrepancies.map((item, i) => (
                                                <div key={i} className={`${theme === 'dark' ? 'bg-gray-900/50' : 'bg-gray-50'} border rounded-lg p-4`}>
                                                    <p className={`font-bold ${theme === 'dark' ? 'text-white' : 'text-gray-900'}`}>{i + 1}. {item.name} ({formatCpf(item.cpf)})</p>
                                                    <table className="w-full text-xs text-left mt-2 table-fixed">
                                                        <thead className={`${theme === 'dark' ? 'bg-gray-600 text-gray-300' : 'bg-gray-100 text-gray-700'}`}><tr><th className="px-3 py-1 w-[30%]">Campo</th><th className="px-3 py-1 w-[35%]">Informação no SOC</th><th className="px-3 py-1 w-[35%]">Informação no Cliente (Editável)</th></tr></thead>
                                                        <tbody>
                                                            {item.details.map((d, j) => (
                                                                <tr key={j} className={`border-b ${theme === 'dark' ? 'border-gray-700' : 'border-gray-200'} last:border-b-0`}>
                                                                    <td className="px-3 py-1 font-medium">{d.field}</td>
                                                                    <td className="px-3 py-1">{d.socValue}</td>
                                                                    <td className="p-1">
                                                                        <input 
                                                                            type="text" 
                                                                            value={d.companyValue}
                                                                            onChange={(e) => handleDiscrepancyChange(i, j, e.target.value)}
                                                                            className={`w-full p-1 rounded text-xs border ${theme === 'dark' ? 'bg-gray-700 border-gray-500 text-yellow-300' : 'bg-white border-gray-300 text-red-700'}`}
                                                                        />
                                                                    </td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            ))}
                                        </div>
                                    </ResultSection>
                                    
                                    {/* Outras seções de resultado aqui... */}

                                    <div className="mt-8 text-center space-y-2 md:space-y-0 md:space-x-4">
                                        <button onClick={handleExport} className="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition-colors duration-300 w-full md:w-auto inline-flex items-center justify-center">
                                            Exportar Planilha SOC Atualizada
                                        </button>
                                        <button onClick={handleClear} className="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition-colors duration-300 w-full md:w-auto inline-flex items-center justify-center">
                                            <TrashIcon />
                                            Limpar
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>
                    <footer className={`text-center text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-gray-500'} mt-8 py-4`}>
                        <p>Versão {APP_VERSION} (React) | Em caso de erro, reportar para robsonmorais@produtiva.srv.br</p>
                    </footer>
                    <UpdateNotesModal isOpen={isUpdateModalOpen} onClose={handleCloseUpdateModal} theme={theme} />
                    <ColumnMappingModal 
                        isOpen={mappingModal.isOpen}
                        onClose={() => setMappingModal({ isOpen: false, fileType: null, headers: [], file: null })}
                        onConfirm={onMappingConfirm}
                        fileHeaders={mappingModal.headers}
                        fileName={mappingModal.file?.name}
                        theme={theme}
                    />
                    <MissingDataModal 
                        isOpen={!!missingDataError} 
                        onClose={() => setMissingDataError(null)}
                        onConfirm={() => {
                            proceedWithGeneration(dataForIncompleteGeneration);
                            setMissingDataError(null);
                        }}
                        missingData={missingDataError}
                        theme={theme}
                    />
                </div>
            );
        }
        
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>
