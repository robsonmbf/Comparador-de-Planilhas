<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparador de Planilhas (React)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS (xlsx) para ler planilhas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- React e ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel para transpilar JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            transition: background-color 0.3s, color 0.3s;
        }
        @keyframes blink {
            50% { opacity: 0; }
        }
        .blinking-text {
            animation: blink 1.5s step-start infinite;
        }
        .detail-view {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .detail-view.open {
            max-height: 20000px; /* Um valor alto para permitir a expansão */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useCallback, useEffect } = React;

        // --- Ícones em SVG ---
        const ThemeToggleIcon = ({ theme }) => (
            theme === 'dark' ? (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-yellow-400"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
            ) : (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-gray-600"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            )
        );
        
        const TrashIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
        );


        // --- Componentes da UI ---
        const Header = ({ theme }) => (
            <div className="text-center mb-8">
                <h1 className={`text-3xl md:text-4xl font-bold ${theme === 'dark' ? 'text-white' : 'text-gray-900'}`}>Verificador de Planilhas</h1>
                <p className={`${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'} mt-2`}>Compare dados de funcionários entre a planilha do SOC e a da empresa.</p>
            </div>
        );

        const Notice = ({ theme }) => (
            <div className={`${theme === 'dark' ? 'bg-gray-900 border-blue-500' : 'bg-blue-50 border-blue-400'} border-l-4 p-4 rounded-lg mb-8`} role="alert">
                <p className="font-bold text-red-500 blinking-text">Atenção!</p>
                <p className={theme === 'dark' ? 'text-gray-200' : 'text-blue-700'}>O sistema busca por nomes de coluna como <strong>CPF</strong>, <strong>Nome</strong>, <strong>Data de Nascimento</strong>, <strong>Data de Admissão</strong> e <strong>Matrícula</strong>.</p>
            </div>
        );

        const FileInput = ({ id, label, onFileSelect, fileInfo, theme }) => (
            <div>
                <div className="flex justify-between items-center mb-2">
                    <label htmlFor={id} className={`block text-sm font-medium ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}`}>{label}</label>
                    {fileInfo && <span className={`text-sm font-medium ${fileInfo.error ? (theme === 'dark' ? 'text-red-400' : 'text-red-600') : (theme === 'dark' ? 'text-green-400' : 'text-green-600')}`}>{fileInfo.message}</span>}
                </div>
                <input
                    type="file"
                    id={id}
                    accept=".xlsx, .xls, .csv"
                    onChange={(e) => onFileSelect(e.target.files[0])}
                    className={`block w-full text-sm ${theme === 'dark' ? 'text-gray-400 file:bg-gray-600 file:text-gray-200 hover:file:bg-gray-500' : 'text-gray-500 file:bg-gray-100 file:text-gray-800 hover:file:bg-gray-200'} file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold cursor-pointer`}
                />
            </div>
        );

        const Loader = ({ text, theme }) => (
            <div className="flex justify-center items-center my-6">
                <div className={`w-10 h-10 border-4 ${theme === 'dark' ? 'border-gray-600' : 'border-gray-200'} border-t-blue-500 rounded-full animate-spin`}></div>
                <p className={`ml-4 ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>{text}</p>
            </div>
        );

        const SummaryCard = ({ value, label, color, theme, onClick, isActive }) => (
            <button 
                onClick={onClick}
                disabled={value === 0 && !onClick}
                className={`w-full p-4 rounded-lg text-center border transition-all duration-300 ${isActive ? `ring-2 ring-offset-2 ${theme === 'dark' ? 'ring-offset-gray-700' : 'ring-offset-white'} ring-${color}-500` : ''} ${value === 0 && onClick ? 'opacity-50 cursor-not-allowed' : 'hover:scale-105'} ${theme === 'dark' ? 'bg-gray-900/50 border-gray-700' : 'bg-white border-gray-200'}`}
            >
                <p className={`text-3xl font-bold text-${color}-${theme === 'dark' ? '400' : '600'}`}>{value}</p>
                <p className={`text-sm font-medium ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}`}>{label}</p>
            </button>
        );

        // --- Mapeamento e Funções Utilitárias ---
        const columnMappings = {
            cpf: ['CPF'],
            nome: ['Nome Funcionário', 'Nome', 'NOME DO FUNCIONÁRIO', 'NOME COMPLETO'],
            dataNascimento: ['Data de Nascimento', 'Dt.Nascimento', 'DATA NASCIMENTO'],
            dataAdmissao: ['Data de Admissão', 'Dt.Admissão', 'DATA ADMISSAO'],
            dataDemissao: ['Data de Demissão', 'Dt.Demissão', 'DATA DEMISSAO'],
            situacao: ['Situação'],
            matricula: ['Matrícula', 'MATRICULA e-SOCIAL DO FUNCIONÁRIO', 'MATRICULA'],
            codFuncionario: ['Cod Funcionário', 'Cód. Funcionário', 'Código do Funcionário']
        };

        const findColumnValue = (row, possibleNames) => {
            const lowerCasePossibleNames = possibleNames.map(name => name.toLowerCase());
            for (const key in row) {
                if (lowerCasePossibleNames.includes(key.toLowerCase().trim())) {
                    return row[key];
                }
            }
            return undefined;
        };

        const normalizeCpf = (cpfValue) => {
            if (cpfValue === null || typeof cpfValue === 'undefined') return '';
            return String(cpfValue).replace(/\D/g, '');
        };

        const formatCpf = (cpf) => {
            const cpfString = String(cpf || '').replace(/\D/g, '');
            if (cpfString.length === 11) {
                return cpfString.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
            }
            return cpf;
        }

        const normalizeName = (nameValue) => {
            if (nameValue === null || typeof nameValue === 'undefined') return '';
            return String(nameValue)
                .toLowerCase()
                .trim()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .replace(/z/g, 's'); // Normaliza 'z' para 's' para evitar falsos positivos
        };

        const normalizeValue = (value) => {
            if (value === null || typeof value === 'undefined') return '';
            if (value instanceof Date) {
                const adjustedDate = new Date(value.getTime() + Math.abs(value.getTimezoneOffset() * 60000));
                return `${String(adjustedDate.getUTCDate()).padStart(2, '0')}/${String(adjustedDate.getUTCMonth() + 1).padStart(2, '0')}/${adjustedDate.getUTCFullYear()}`;
            }
            const stringValue = String(value).trim();
            const dateMatch = stringValue.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/);
            if (dateMatch) {
                return `${dateMatch[1].padStart(2, '0')}/${dateMatch[2].padStart(2, '0')}/${dateMatch[3]}`;
            }
            return stringValue;
        };

        const getCpfInvalidityReason = (originalCpf) => {
            const normalized = normalizeCpf(originalCpf);
            if (!normalized) return "CPF em branco";
            if (normalized.length !== 11) return `Contém ${normalized.length} dígitos (esperado 11)`;
            return null;
        };

        // --- Componente Principal ---
        function App() {
            const [theme, setTheme] = useState('dark');
            const [activeDetail, setActiveDetail] = useState(null);
            const [socFile, setSocFile] = useState(null);
            const [companyFile, setCompanyFile] = useState(null);
            const [socFileInfo, setSocFileInfo] = useState(null);
            const [companyFileInfo, setCompanyFileInfo] = useState(null);

            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState(null);
            const [results, setResults] = useState(null);
            const [originalSocData, setOriginalSocData] = useState(null);

            useEffect(() => {
                document.body.className = theme === 'dark' ? 'bg-gray-800 text-gray-200' : 'bg-gray-100 text-gray-800';
            }, [theme]);
            
            const toggleTheme = () => {
                setTheme(prevTheme => prevTheme === 'dark' ? 'light' : 'dark');
            };

            const handleDetailToggle = (detail) => {
                setActiveDetail(prevDetail => prevDetail === detail ? null : detail);
            };

            const readAndProcessSheet = (file) => {
                return new Promise((resolve, reject) => {
                    if (!file) {
                        return reject(new Error("Arquivo não fornecido."));
                    }
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = new Uint8Array(event.target.result);
                            const workbook = XLSX.read(data, { type: 'array', cellDates: true });

                            let jsonData = [], headerRow = [], columnMap = {};
                            let foundHeader = false;

                            for (const sheetName of workbook.SheetNames) {
                                const worksheet = workbook.Sheets[sheetName];
                                const dataAsArray = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });
                                if (dataAsArray.length === 0) continue;

                                let headerIndex = -1;
                                const keywords = ['cpf', 'nome', 'nascimento', 'admissão', 'matrícula'];
                                for (let i = 0; i < Math.min(dataAsArray.length, 10); i++) {
                                    const rowString = dataAsArray[i].join(' ').toLowerCase();
                                    if (keywords.filter(k => rowString.includes(k)).length >= 3) {
                                        headerIndex = i;
                                        break;
                                    }
                                }

                                if (headerIndex !== -1) {
                                    headerRow = dataAsArray[headerIndex].map(h => String(h).trim());
                                    const dataRows = dataAsArray.slice(headerIndex + 1);
                                    jsonData = dataRows.map(row => {
                                        const obj = {};
                                        headerRow.forEach((key, index) => { if (key) obj[key] = row[index]; });
                                        return obj;
                                    }).filter(obj => Object.values(obj).some(val => val !== ""));
                                    
                                    for (const standardKey in columnMappings) {
                                        const foundHeaderName = headerRow.find(h => columnMappings[standardKey].map(n => n.toLowerCase()).includes(h.toLowerCase()));
                                        if (foundHeaderName) columnMap[standardKey] = foundHeaderName;
                                    }
                                    
                                    foundHeader = true;
                                    break;
                                }
                            }
                            if (!foundHeader) throw new Error("Não foi possível encontrar uma linha de cabeçalho (com colunas como CPF, Nome, etc.).");
                            resolve({ jsonData, headerRow, columnMap });
                        } catch (e) {
                            reject(e);
                        }
                    };
                    reader.onerror = (e) => reject(new Error("Erro ao ler o arquivo: " + e));
                    reader.readAsArrayBuffer(file);
                });
            };

            const handleFileSelect = async (file, fileType) => {
                const setFile = fileType === 'soc' ? setSocFile : setCompanyFile;
                const setInfo = fileType === 'soc' ? setSocFileInfo : setCompanyFileInfo;
                
                setFile(file);
                if (!file) {
                    setInfo(null);
                    return;
                }

                setInfo({ message: 'Lendo...' });
                try {
                    const { jsonData } = await readAndProcessSheet(file);
                    const validData = jsonData.filter(row => getCpfInvalidityReason(findColumnValue(row, columnMappings.cpf)) === null);
                    setInfo({ message: `${validData.length} funcionários` });
                } catch (error) {
                    setInfo({ message: 'Erro ao ler', error: true });
                    console.error(`Erro ao ler o arquivo ${fileType}:`, error);
                }
            };
            
            const handleCompare = useCallback(async () => {
                setActiveDetail(null);
                if (!socFile || !companyFile) {
                    setError({ title: 'Arquivos Faltando', message: 'Por favor, selecione os dois arquivos de planilha para continuar.' });
                    setResults(null);
                    return;
                }
                
                setIsLoading(true);
                setError(null);
                setResults(null);

                try {
                    const socFileData = await readAndProcessSheet(socFile);
                    setOriginalSocData({ raw: socFileData.jsonData, headers: socFileData.headerRow, columnMap: socFileData.columnMap });
                    
                    const companyFileData = await readAndProcessSheet(companyFile);

                    const standardizeData = (data) => data.map(row => ({
                        cpf: findColumnValue(row, columnMappings.cpf),
                        nome: findColumnValue(row, columnMappings.nome),
                        dataNascimento: findColumnValue(row, columnMappings.dataNascimento),
                        dataAdmissao: findColumnValue(row, columnMappings.dataAdmissao),
                        dataDemissao: findColumnValue(row, columnMappings.dataDemissao),
                        situacao: findColumnValue(row, columnMappings.situacao),
                        matricula: findColumnValue(row, columnMappings.matricula),
                        codFuncionario: findColumnValue(row, columnMappings.codFuncionario)
                    }));
                    
                    const socData = standardizeData(socFileData.jsonData);
                    const companyData = standardizeData(companyFileData.jsonData);
                    
                    const invalidCpfs = [];
                    const filterValidData = (data, source) => data.filter(row => {
                        const reason = getCpfInvalidityReason(row.cpf);
                        if (reason) {
                            invalidCpfs.push({ name: row.nome || 'Não informado', cpf: normalizeValue(row.cpf) || 'Vazio', source, reason });
                            return false;
                        }
                        return true;
                    });

                    const validSocData = filterValidData(socData, 'Planilha SOC');
                    const validCompanyData = filterValidData(companyData, 'Planilha da Empresa');
                    
                    const discrepancies = [], newEmployees = [], socMap = new Map();
                    
                    // Verificação de duplicados no SOC
                    const socDuplicates = new Map();
                    validSocData.forEach(row => {
                        const cpf = normalizeCpf(row.cpf);
                        if (!socDuplicates.has(cpf)) {
                            socDuplicates.set(cpf, []);
                        }
                        socDuplicates.get(cpf).push(row);
                    });

                    socDuplicates.forEach((group, cpf) => {
                        if (group.length > 1) {
                            const statuses = new Set(group.map(emp => normalizeValue(emp.situacao)));
                            if (statuses.size > 1) {
                                discrepancies.push({
                                    cpf: formatCpf(cpf),
                                    name: group[0].nome,
                                    isInternal: true,
                                    details: group.map(emp => ({
                                        codFuncionario: emp.codFuncionario,
                                        situacao: normalizeValue(emp.situacao) || 'Não informada'
                                    }))
                                });
                            }
                        }
                    });

                    validSocData.forEach(row => socMap.set(normalizeCpf(row.cpf), row));

                    validCompanyData.forEach(companyRow => {
                        const companyCpf = normalizeCpf(companyRow.cpf);
                        const socRow = socMap.get(companyCpf);

                        if (socRow) {
                            const employeeDiscrepancies = [];
                            const fieldsToCompare = {
                                'Nome': { soc: socRow.nome, comp: companyRow.nome, normalize: normalizeName },
                                'Data de Nascimento': { soc: socRow.dataNascimento, comp: companyRow.dataNascimento, normalize: normalizeValue },
                                'Data de Admissão': { soc: socRow.dataAdmissao, comp: companyRow.dataAdmissao, normalize: normalizeValue },
                                'Matrícula': { soc: socRow.matricula, comp: companyRow.matricula, normalize: normalizeValue },
                                'Data de Demissão': { soc: socRow.dataDemissao, comp: companyRow.dataDemissao, normalize: normalizeValue }
                            };

                            for (const field in fieldsToCompare) {
                                const { soc, comp, normalize } = fieldsToCompare[field];
                                if (normalize(soc) !== normalize(comp)) {
                                    employeeDiscrepancies.push({ 
                                        field, 
                                        socValue: normalizeValue(soc) || 'Não consta no SOC', 
                                        companyValue: normalizeValue(comp) || 'Não consta na Empresa' 
                                    });
                                }
                            }

                            if (employeeDiscrepancies.length > 0) {
                                discrepancies.push({
                                    cpf: normalizeValue(companyRow.cpf),
                                    name: companyRow.nome || `Funcionário com CPF ${normalizeValue(companyRow.cpf)}`,
                                    matricula: normalizeValue(companyRow.matricula) || 'Não informada',
                                    isInternal: false,
                                    details: employeeDiscrepancies
                                });
                            }
                            socMap.delete(companyCpf);
                        } else {
                            newEmployees.push(companyRow);
                        }
                    });

                    const removedEmployees = Array.from(socMap.values()).map(emp => ({
                        ...emp,
                        status: normalizeValue(emp.dataDemissao) 
                            ? `Desligado no SOC (em ${normalizeValue(emp.dataDemissao)}) e não consta na planilha da Empresa` 
                            : 'Ativo no SOC, mas não consta na planilha da Empresa'
                    }));
                    
                    setResults({ 
                        discrepancies, 
                        newEmployees, 
                        invalidCpfs, 
                        removedEmployees, 
                        socData: validSocData, 
                        companyData: validCompanyData 
                    });

                } catch (e) {
                    console.error("Erro na comparação:", e);
                    setError({ title: `Erro ao Processar Arquivo`, message: e.message, suggestion: "Verifique se o arquivo não está corrompido e se os nomes das colunas estão corretos. Tente salvar a planilha no formato .xlsx." });
                } finally {
                    setIsLoading(false);
                }
            }, [socFile, companyFile]);

            const handleClear = () => {
                setSocFile(null);
                setCompanyFile(null);
                setSocFileInfo(null);
                setCompanyFileInfo(null);
                setResults(null);
                setError(null);
                setIsLoading(false);
                setOriginalSocData(null);
                setActiveDetail(null);
                document.getElementById('soc-file').value = '';
                document.getElementById('company-file').value = '';
            };
            
            const handleExport = () => {
                if (!originalSocData || !results) {
                    alert("Não há dados para exportar.");
                    return;
                }

                let updatedData = JSON.parse(JSON.stringify(originalSocData.raw));
                const { columnMap, headers } = originalSocData;
                
                const situacaoHeader = columnMap.situacao;
                const cpfHeader = columnMap.cpf;

                if (!situacaoHeader || !cpfHeader) {
                    alert("Não foi possível encontrar as colunas 'Situação' ou 'CPF' na planilha SOC para atualizar.");
                    return;
                }
                
                const removedCpfSet = new Set(results.removedEmployees.map(emp => normalizeCpf(emp.cpf)));
                updatedData.forEach(row => {
                    if (removedCpfSet.has(normalizeCpf(row[cpfHeader]))) {
                        row[situacaoHeader] = 'N';
                    }
                });

                results.newEmployees.forEach(newEmp => {
                    const newRow = {};
                    headers.forEach(header => { newRow[header] = ''; });
                    for (const key in columnMap) {
                        if (columnMap[key] && newEmp[key] !== undefined) {
                            newRow[columnMap[key]] = newEmp[key];
                        }
                    }
                    newRow[situacaoHeader] = 'S';
                    updatedData.push(newRow);
                });
                
                const outputData = [
                    ['Modelo 1'],
                    headers, 
                    ...updatedData.map(row => headers.map(header => row[header] || ''))
                ];
                const worksheet = XLSX.utils.aoa_to_sheet(outputData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Funcionários Atualizados");
                XLSX.writeFile(workbook, "Planilha_SOC_Atualizada.xlsx");
            };

            const EmployeeList = ({ employees, theme }) => (
                <div className="overflow-x-auto">
                    <table className="w-full text-sm text-left">
                        <thead className={`${theme === 'dark' ? 'bg-gray-600 text-gray-300' : 'bg-gray-50 text-gray-700'} text-xs uppercase sticky top-0`}>
                            <tr>
                                <th className="px-2 py-2 w-12 text-center">#</th>
                                <th className="px-4 py-2">Nome</th>
                                <th className="px-4 py-2">CPF</th>
                                <th className="px-4 py-2">Nascimento</th>
                                <th className="px-4 py-2">Admissão</th>
                                <th className="px-4 py-2">Matrícula</th>
                            </tr>
                        </thead>
                        <tbody>
                            {employees.map((item, i) => (
                                <tr key={i} className={`border-b ${theme === 'dark' ? 'border-gray-600' : 'border-gray-200'}`}>
                                    <td className="px-2 py-2 text-center">{i + 1}</td>
                                    <td className="px-4 py-2">{item.nome || 'Não consta'}</td>
                                    <td className="px-4 py-2 font-mono">{formatCpf(item.cpf) || 'Não consta'}</td>
                                    <td className="px-4 py-2">{normalizeValue(item.dataNascimento) || 'Não consta'}</td>
                                    <td className="px-4 py-2">{normalizeValue(item.dataAdmissao) || 'Não consta'}</td>
                                    <td className="px-4 py-2">{normalizeValue(item.matricula) || 'Não consta'}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
            
            const renderDetailView = () => {
                if (!results) return null;

                const detailContent = {
                    socEmployees: <EmployeeList employees={results.socData} theme={theme} />,
                    companyEmployees: <EmployeeList employees={results.companyData} theme={theme} />,
                    discrepancies: (
                        <div className="space-y-4">
                            {results.discrepancies.map((item, i) => (
                                <div key={i} className={`${theme === 'dark' ? 'bg-gray-800 border-gray-600' : 'bg-white border-gray-200'} border rounded-lg p-4`}>
                                    <p className={`font-bold ${theme === 'dark' ? 'text-white' : 'text-gray-900'}`}>{item.name}</p>
                                    <div className={`flex flex-wrap gap-x-4 text-xs ${theme === 'dark' ? 'text-gray-400' : 'text-gray-500'} mb-2`}><span><strong>CPF:</strong> {formatCpf(item.cpf)}</span>{ !item.isInternal && <span><strong>Matrícula:</strong> {item.matricula}</span>}</div>
                                    {item.isInternal ? (
                                        <table className="w-full text-xs text-left mt-2">
                                            <thead className={`${theme === 'dark' ? 'bg-gray-600 text-gray-300' : 'bg-gray-100 text-gray-700'}`}><tr><th className="px-3 py-1">Cod Funcionário</th><th className="px-3 py-1">Situação no SOC</th></tr></thead>
                                            <tbody>{item.details.map((d, j) => <tr key={j} className={`border-b ${theme === 'dark' ? 'border-gray-700' : 'border-gray-200'} last:border-b-0`}><td className={`px-3 py-1 ${theme === 'dark' ? 'bg-red-900/40 text-red-300' : 'bg-red-50 text-red-700'}`}>{d.codFuncionario}</td><td className={`px-3 py-1 ${theme === 'dark' ? 'bg-red-900/40 text-red-300' : 'bg-red-50 text-red-700'}`}>{d.situacao}</td></tr>)}</tbody>
                                        </table>
                                    ) : (
                                        <table className="w-full text-xs text-left mt-2">
                                            <thead className={`${theme === 'dark' ? 'bg-gray-600 text-gray-300' : 'bg-gray-100 text-gray-700'}`}><tr><th className="px-3 py-1">Campo</th><th className="px-3 py-1">Valor no SOC</th><th className="px-3 py-1">Valor na Empresa</th></tr></thead>
                                            <tbody>{item.details.map((d, j) => <tr key={j} className={`border-b ${theme === 'dark' ? 'border-gray-700' : 'border-gray-200'} last:border-b-0`}><td className="px-3 py-1 font-medium">{d.field}</td><td className={`px-3 py-1 ${theme === 'dark' ? 'bg-red-900/40 text-red-300' : 'bg-red-50 text-red-700'}`}>{d.socValue}</td><td className={`px-3 py-1 ${theme === 'dark' ? 'bg-red-900/40 text-red-300' : 'bg-red-50 text-red-700'}`}>{d.companyValue}</td></tr>)}</tbody>
                                        </table>
                                    )}
                                </div>
                            ))}
                        </div>
                    ),
                    newEmployees: (
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className={`${theme === 'dark' ? 'bg-gray-600 text-gray-300' : 'bg-gray-50 text-gray-700'} text-xs uppercase`}><tr><th className="px-4 py-2">Nome</th><th className="px-4 py-2">CPF</th><th className="px-4 py-2">Matrícula</th></tr></thead>
                                <tbody>{results.newEmployees.map((item, i) => <tr key={i} className={`border-b ${theme === 'dark' ? 'border-gray-600' : 'border-gray-200'}`}><td className="px-4 py-2">{item.nome || 'Não consta'}</td><td className="px-4 py-2 font-mono">{formatCpf(item.cpf) || 'Não consta'}</td><td className="px-4 py-2">{normalizeValue(item.matricula) || 'Não consta'}</td></tr>)}</tbody>
                            </table>
                        </div>
                    ),
                    removedEmployees: (
                         <div className="space-y-2">
                            {results.removedEmployees.map((item, i) => (
                                <div key={i} className={`p-4 border ${theme === 'dark' ? 'border-gray-600' : 'border-gray-200'} rounded-lg`}>
                                    <p className={`font-semibold ${theme === 'dark' ? 'text-white' : 'text-gray-800'}`}>{item.nome || 'Não informado'}</p>
                                    <p className={`text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'} font-mono`}>{formatCpf(item.cpf)}</p>
                                    <p className={`text-sm ${theme === 'dark' ? 'text-red-400' : 'text-red-600'} mt-1`}>{item.status}</p>
                                </div>
                            ))}
                        </div>
                    ),
                    invalidCpfs: (
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className={`${theme === 'dark' ? 'bg-gray-600 text-gray-300' : 'bg-gray-50 text-gray-700'} text-xs uppercase`}><tr><th className="px-4 py-2">Nome</th><th className="px-4 py-2">CPF Informado</th><th className="px-4 py-2">Motivo</th><th className="px-4 py-2">Origem</th></tr></thead>
                                <tbody>{results.invalidCpfs.map((item, i) => <tr key={i} className={`border-b ${theme === 'dark' ? 'border-gray-600' : 'border-gray-200'}`}><td className="px-4 py-2">{item.name}</td><td className={`px-4 py-2 font-mono ${theme === 'dark' ? 'text-red-400' : 'text-red-600'}`}>{formatCpf(item.cpf)}</td><td className="px-4 py-2">{item.reason}</td><td className="px-4 py-2">{item.source}</td></tr>)}</tbody>
                            </table>
                        </div>
                    )
                };

                return (
                    <div className={`detail-view ${activeDetail ? 'open' : ''}`}>
                        <div className="p-4 mt-4 border-t border-gray-500/50">
                            {detailContent[activeDetail]}
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen flex flex-col items-center p-4">
                    <main className={`relative ${theme === 'dark' ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-200'} rounded-2xl shadow-xl p-6 md:p-10 w-full max-w-6xl border`}>
                        <button onClick={toggleTheme} className="absolute top-4 right-4 p-2 rounded-full bg-gray-500/20 hover:bg-gray-500/40 transition-colors">
                            <ThemeToggleIcon theme={theme} />
                        </button>
                        
                        <Header theme={theme} />
                        <Notice theme={theme} />
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                            <FileInput id="soc-file" label="1. Planilha Modelo SOC" onFileSelect={(file) => handleFileSelect(file, 'soc')} fileInfo={socFileInfo} theme={theme} />
                            <FileInput id="company-file" label="2. Planilha Recente da Empresa" onFileSelect={(file) => handleFileSelect(file, 'company')} fileInfo={companyFileInfo} theme={theme} />
                        </div>

                        <div className="text-center">
                            <button
                                onClick={handleCompare}
                                disabled={isLoading}
                                className="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 disabled:bg-gray-500"
                            >
                                {isLoading ? 'Analisando...' : 'Verificar Dados'}
                            </button>
                        </div>

                        <div className="mt-10">
                            {isLoading && <Loader text="Analisando dados..." theme={theme} />}
                            {error && (
                                <div className={`${theme === 'dark' ? 'bg-red-900/50 border-red-700 text-red-300' : 'bg-red-100 border-red-500 text-red-700'} border p-4 rounded-lg`} role="alert">
                                    <p className="font-bold">{error.title}</p>
                                    <p>{error.message}</p>
                                    {error.suggestion && <p className="mt-2 text-sm"><strong>Sugestão:</strong> {error.suggestion}</p>}
                                </div>
                            )}
                            {results && (
                                <div>
                                    <div className="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8">
                                        <SummaryCard value={results.socData.length} label="Funcionários no SOC" color="blue" theme={theme} onClick={() => handleDetailToggle('socEmployees')} isActive={activeDetail === 'socEmployees'} />
                                        <SummaryCard value={results.companyData.length} label="Funcionários na Empresa" color="green" theme={theme} onClick={() => handleDetailToggle('companyEmployees')} isActive={activeDetail === 'companyEmployees'} />
                                        <SummaryCard value={results.discrepancies.length} label="Divergências" color="red" theme={theme} onClick={() => handleDetailToggle('discrepancies')} isActive={activeDetail === 'discrepancies'} />
                                        <SummaryCard value={results.newEmployees.length} label="Novos Funcionários" color="green" theme={theme} onClick={() => handleDetailToggle('newEmployees')} isActive={activeDetail === 'newEmployees'} />
                                        <SummaryCard value={results.removedEmployees.length} label="Situação de Funcionário" color="purple" theme={theme} onClick={() => handleDetailToggle('removedEmployees')} isActive={activeDetail === 'removedEmployees'} />
                                        <SummaryCard value={results.invalidCpfs.length} label="CPFs Inválidos" color="yellow" theme={theme} onClick={() => handleDetailToggle('invalidCpfs')} isActive={activeDetail === 'invalidCpfs'} />
                                    </div>
                                    
                                    {renderDetailView()}

                                    <div className="mt-8 text-center space-y-2 md:space-y-0 md:space-x-4">
                                        <button onClick={handleExport} className="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition-colors duration-300 w-full md:w-auto inline-flex items-center justify-center">
                                            Exportar Planilha SOC Atualizada
                                        </button>
                                        <button onClick={handleClear} className="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition-colors duration-300 w-full md:w-auto inline-flex items-center justify-center">
                                            <TrashIcon />
                                            Limpar
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>
                    <footer className={`text-center text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-gray-500'} mt-8 py-4`}>
                        <p>Versão 3.2 (React) | Em caso de erro, reportar para robsonmorais@produtiva.srv.br</p>
                    </footer>
                </div>
            );
        }
        
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>
