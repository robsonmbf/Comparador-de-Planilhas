<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparador de Planilhas (React)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS (xlsx) para ler planilhas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- React e ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel para transpilar JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            transition: background-color 0.3s, color 0.3s;
        }
        @keyframes blink {
            50% { opacity: 0; }
        }
        .blinking-text {
            animation: blink 1.5s step-start infinite;
        }
        .detail-view {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .detail-view.open {
            max-height: 20000px; /* Um valor alto para permitir a expansão */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useCallback, useEffect, useRef } = React;

        const APP_VERSION = "4.8";

        // --- Ícones em SVG ---
        const ThemeToggleIcon = ({ theme }) => (
            theme === 'dark' ? (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-yellow-400"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
            ) : (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-gray-600"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            )
        );
        
        const TrashIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
        );

        const SendIcon = () => (
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
        );

        // --- Componentes da UI ---
        const Header = ({ theme }) => (
            <div className="text-center mb-8">
                <h1 className={`text-3xl md:text-4xl font-bold ${theme === 'dark' ? 'text-white' : 'text-gray-900'}`}>Verificador de Planilhas</h1>
                <p className={`${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'} mt-2`}>Compare ou gere planilhas de funcionários.</p>
            </div>
        );

        const Notice = ({ theme }) => (
            <div className={`${theme === 'dark' ? 'bg-gray-900 border-blue-500' : 'bg-blue-50 border-blue-400'} border-l-4 p-4 rounded-lg mb-8 text-sm`}>
                <p className={`font-bold ${theme === 'dark' ? 'text-white' : 'text-gray-800'}`}>Dicas:</p>
                <ul className={`list-disc list-inside mt-2 space-y-1 ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}`}>
                    <li>Antes de realizar a importação verifique se está logado na empresa correta.</li>
                    <li>Orientamos que sejam realizados testes com poucos dados, principalmente se a planilha conter diversas alterações.</li>
                    <li>Em caso de dúvidas consulte o Manual de Importação ou o Suporte SOC.</li>
                </ul>
                <p className={`mt-4 ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}><strong className="font-semibold">Obs:</strong> Se a planilha apresentar mais de 200 registros, será gerado um Pedido de Processamento.</p>
                <p className={`mt-4 font-bold ${theme === 'dark' ? 'text-yellow-400' : 'text-yellow-600'}`}>Importação de Dados é de inteira responsabilidade do usuário, sendo assim o Suporte SOC não está autorizado a realizar correções.</p>
            </div>
        );

        const FileInput = ({ id, label, onFileSelect, fileInfo, theme }) => (
            <div>
                <div className="flex justify-between items-center mb-2">
                    <label htmlFor={id} className={`block text-sm font-medium ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}`}>{label}</label>
                    {fileInfo && <span className={`text-sm font-medium ${fileInfo.error ? (theme === 'dark' ? 'text-red-400' : 'text-red-600') : (theme === 'dark' ? 'text-green-400' : 'text-green-600')}`}>{fileInfo.message}</span>}
                </div>
                <input
                    type="file"
                    id={id}
                    accept=".xlsx, .xls, .csv"
                    onChange={(e) => onFileSelect(e.target.files[0])}
                    className={`block w-full text-sm ${theme === 'dark' ? 'text-gray-400 file:bg-gray-600 file:text-gray-200 hover:file:bg-gray-500' : 'text-gray-500 file:bg-gray-100 file:text-gray-800 hover:file:bg-gray-200'} file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold cursor-pointer`}
                />
            </div>
        );

        const Loader = ({ text, theme }) => (
            <div className="flex justify-center items-center my-6">
                <div className={`w-10 h-10 border-4 ${theme === 'dark' ? 'border-gray-600' : 'border-gray-200'} border-t-blue-500 rounded-full animate-spin`}></div>
                <p className={`ml-4 ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>{text}</p>
            </div>
        );

        const SummaryCard = ({ value, label, color, theme, onClick, isActive }) => (
            <button 
                onClick={onClick}
                disabled={value === 0 && !onClick}
                className={`w-full p-4 rounded-lg text-center border transition-all duration-300 ${isActive ? `ring-2 ring-offset-2 ${theme === 'dark' ? 'ring-offset-gray-700' : 'ring-offset-white'} ring-${color}-500` : ''} ${value === 0 && onClick ? 'opacity-50 cursor-not-allowed' : 'hover:scale-105'} ${theme === 'dark' ? 'bg-gray-900/50 border-gray-700' : 'bg-white border-gray-200'}`}
            >
                <p className={`text-3xl font-bold text-${color}-${theme === 'dark' ? '400' : '600'}`}>{value}</p>
                <p className={`text-sm font-medium ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}`}>{label}</p>
            </button>
        );
        
        const StatusSummaryCard = ({ active, inactive, label, theme, onClick, isActive }) => (
            <button 
                onClick={onClick}
                disabled={(active + inactive) === 0}
                className={`w-full p-4 rounded-lg text-center border transition-all duration-300 ${isActive ? `ring-2 ring-offset-2 ${theme === 'dark' ? 'ring-offset-gray-700' : 'ring-offset-white'} ring-blue-500` : ''} ${(active + inactive) === 0 ? 'opacity-50 cursor-not-allowed' : 'hover:scale-105'} ${theme === 'dark' ? 'bg-gray-900/50 border-gray-700' : 'bg-white border-gray-200'}`}
            >
                <div className="flex justify-center items-center space-x-4">
                    <div>
                        <p className={`text-3xl font-bold text-green-${theme === 'dark' ? '400' : '600'}`}>{active}</p>
                        <p className={`text-xs font-medium ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>Ativos</p>
                    </div>
                     <div>
                        <p className={`text-3xl font-bold text-red-${theme === 'dark' ? '400' : '600'}`}>{inactive}</p>
                        <p className={`text-xs font-medium ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>Inativos</p>
                    </div>
                </div>
                <p className={`text-sm font-medium mt-2 ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}`}>{label}</p>
            </button>
        );
        
        // --- Mapeamento e Funções Utilitárias ---
        const columnMappings = {
            cpf: ['CPF'],
            nome: ['Nome Funcionário', 'Nome', 'NOME DO FUNCIONÁRIO', 'NOME COMPLETO'],
            dataNascimento: ['Data de Nascimento', 'Dt.Nascimento', 'DATA NASCIMENTO'],
            dataAdmissao: ['Data de Admissão', 'Dt.Admissão', 'DATA ADMISSAO'],
            dataDemissao: ['Data de Demissão', 'Dt.Demissão', 'DATA DEMISSAO'],
            situacao: ['Situação'],
            sexo: ['Sexo'],
            matricula: ['Matrícula', 'MATRICULA e-SOCIAL DO FUNCIONÁRIO', 'MATRICULA'],
            codFuncionario: ['Cod Funcionário', 'Cód. Funcionário', 'Código do Funcionário'],
            nomeCargo: ['Cargo', 'Nome Cargo', 'Função', 'CARGO/ FUNÇÃO DE ACORDO COM e-SOCIAL'],
            nomeSetor: ['Setor', 'Nome Setor', 'Departamento']
        };

        const abbreviations = {
            'adm': 'Administrativo',
            'aux': 'Auxiliar',
            'op': 'Operacional',
            'tec': 'Técnico',
            'serv': 'Serviços',
            'ger': 'Gerais',
        };

        const findColumnValue = (row, possibleNames) => {
            const lowerCasePossibleNames = possibleNames.map(name => name.toLowerCase());
            for (const key in row) {
                if (lowerCasePossibleNames.includes(key.toLowerCase().trim())) {
                    return row[key];
                }
            }
            return undefined;
        };

        const normalizeCpf = (cpfValue) => {
            if (cpfValue === null || typeof cpfValue === 'undefined') return '';
            let cpfString = String(cpfValue).replace(/\D/g, '');
            // Adiciona zeros à esquerda se o CPF tiver menos de 11 dígitos
            while (cpfString.length > 0 && cpfString.length < 11) {
                cpfString = '0' + cpfString;
            }
            return cpfString;
        };

        const formatCpf = (cpf) => {
            const cpfString = String(cpf || '').replace(/\D/g, '');
            if (cpfString.length === 11) {
                return cpfString.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
            }
            return cpf;
        }

        const normalizeName = (nameValue) => {
            if (nameValue === null || typeof nameValue === 'undefined') return '';
            return String(nameValue)
                .toLowerCase()
                .trim()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .replace(/z/g, 's'); // Normaliza 'z' para 's' para evitar falsos positivos
        };

        const normalizeValue = (value) => {
            if (value === null || typeof value === 'undefined') return '';
            if (value instanceof Date) {
                const adjustedDate = new Date(value.getTime() + Math.abs(value.getTimezoneOffset() * 60000));
                return `${String(adjustedDate.getUTCDate()).padStart(2, '0')}/${String(adjustedDate.getUTCMonth() + 1).padStart(2, '0')}/${adjustedDate.getUTCFullYear()}`;
            }
            const stringValue = String(value).trim();
            const dateMatch = stringValue.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/);
            if (dateMatch) {
                return `${dateMatch[1].padStart(2, '0')}/${dateMatch[2].padStart(2, '0')}/${dateMatch[3]}`;
            }
            return stringValue;
        };

        const formatTitleCase = (str) => {
            if (!str || typeof str !== 'string') return '';
            const exceptions = ['da', 'de', 'do', 'dos', 'das', 'em'];
            let formattedStr = str.toLowerCase().replace(/\s+/g, ' ').trim(); // Remove espaços extras
            
            // Expande abreviações
            formattedStr = formattedStr.split(' ').map(word => abbreviations[word] || word).join(' ');

            // Remove palavras duplicadas
            formattedStr = [...new Set(formattedStr.split(' '))].join(' ');

            return formattedStr
                .split(' ')
                .map(word => exceptions.includes(word) ? word : word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        };

        const getCpfInvalidityReason = (originalCpf) => {
            const normalized = normalizeCpf(originalCpf);
            if (!normalized) return "CPF em branco";
            if (normalized.length !== 11) return `Contém ${normalized.length} dígitos (esperado 11)`;
            return null;
        };

        const standardizeData = (data) => data.map(row => ({
            cpf: findColumnValue(row, columnMappings.cpf),
            nome: findColumnValue(row, columnMappings.nome),
            dataNascimento: findColumnValue(row, columnMappings.dataNascimento),
            dataAdmissao: findColumnValue(row, columnMappings.dataAdmissao),
            dataDemissao: findColumnValue(row, columnMappings.dataDemissao),
            situacao: findColumnValue(row, columnMappings.situacao),
            sexo: findColumnValue(row, columnMappings.sexo),
            matricula: findColumnValue(row, columnMappings.matricula),
            codFuncionario: findColumnValue(row, columnMappings.codFuncionario),
            nomeCargo: findColumnValue(row, columnMappings.nomeCargo),
            nomeSetor: findColumnValue(row, columnMappings.nomeSetor),
        }));

        // --- Componente do Chat de IA ---
        const ChatModal = ({ isOpen, onClose, theme }) => {
            const [messages, setMessages] = useState([
                { role: 'assistant', text: 'Olá! Como posso ajudar você a usar o Verificador de Planilhas?' }
            ]);
            const [input, setInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const messagesEndRef = useRef(null);

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };

            useEffect(scrollToBottom, [messages]);

            const handleSendMessage = async (e) => {
                e.preventDefault();
                if (!input.trim() || isLoading) return;

                const userMessage = { role: 'user', text: input };
                setMessages(prev => [...prev, userMessage]);
                setInput('');
                setIsLoading(true);

                const context = "Você é um assistente prestativo para um aplicativo chamado 'Verificador de Planilhas'. Sua função é ajudar os usuários a entender como usar a ferramenta. A ferramenta compara duas planilhas de funcionários (uma do SOC, outra da empresa) para encontrar divergências, novos funcionários, funcionários removidos e CPFs inválidos. Responda de forma concisa e amigável.";
                const prompt = `${context}\n\nO usuário pergunta: ${input}`;
                
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                
                try {
                    const payload = { contents: chatHistory };
                    const apiKey = ""; // A CHAVE FOI REMOVIDA POR SEGURANÇA
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    
                    if (!apiKey) {
                        throw new Error("Chave de API não configurada.");
                    }

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API error: ${response.statusText}`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        setMessages(prev => [...prev, { role: 'assistant', text }]);
                    } else {
                        throw new Error("Resposta da API inválida.");
                    }
                } catch (error) {
                    console.error("Erro ao chamar a API Gemini:", error);
                    setMessages(prev => [...prev, { role: 'assistant', text: 'Desculpe, a função de ajuda está temporariamente indisponível. A chave de API precisa ser configurada.' }]);
                } finally {
                    setIsLoading(false);
                }
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-end justify-end p-4 z-50">
                    <div className={`w-full max-w-md h-2/3 flex flex-col rounded-lg shadow-2xl ${theme === 'dark' ? 'bg-gray-800 border border-gray-700' : 'bg-white'}`}>
                        <div className={`p-4 border-b ${theme === 'dark' ? 'border-gray-700' : 'border-gray-200'} flex justify-between items-center`}>
                            <h3 className={`font-bold ${theme === 'dark' ? 'text-white' : 'text-gray-900'}`}>Assistente de Ajuda</h3>
                            <button onClick={onClose} className={`${theme === 'dark' ? 'text-gray-400 hover:text-white' : 'text-gray-500 hover:text-gray-800'}`}>&times;</button>
                        </div>
                        <div className="flex-1 p-4 overflow-y-auto">
                            {messages.map((msg, index) => (
                                <div key={index} className={`flex mb-4 ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                    <div className={`max-w-xs md:max-w-md rounded-lg px-4 py-2 ${msg.role === 'user' ? 'bg-blue-600 text-white' : (theme === 'dark' ? 'bg-gray-700 text-gray-200' : 'bg-gray-200 text-gray-800')}`}>
                                        {msg.text}
                                    </div>
                                </div>
                            ))}
                             {isLoading && (
                                <div className="flex justify-start">
                                    <div className={`rounded-lg px-4 py-2 ${theme === 'dark' ? 'bg-gray-700 text-gray-200' : 'bg-gray-200 text-gray-800'}`}>
                                        <span className="animate-pulse">Digitando...</span>
                                    </div>
                                </div>
                            )}
                            <div ref={messagesEndRef} />
                        </div>
                        <form onSubmit={handleSendMessage} className={`p-4 border-t ${theme === 'dark' ? 'border-gray-700' : 'border-gray-200'} flex items-center`}>
                            <input
                                type="text"
                                value={input}
                                onChange={(e) => setInput(e.target.value)}
                                placeholder="Pergunte algo..."
                                className={`flex-1 p-2 rounded-lg border ${theme === 'dark' ? 'bg-gray-700 border-gray-600 text-white' : 'bg-white border-gray-300 text-gray-900'}`}
                            />
                            <button type="submit" className="ml-2 p-2 rounded-full bg-blue-600 text-white hover:bg-blue-700 disabled:bg-gray-500">
                                <SendIcon />
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- Componente de Notas de Atualização ---
        const UpdateNotesModal = ({ isOpen, onClose, theme }) => {
             const updateHistory = [
                {
                    version: "4.5",
                    notes: [
                        { type: 'improvement', text: 'Aprimorada a funcionalidade "Gerar Modelo SOC" para seguir estritamente o layout oficial do Modelo 1.' },
                    ]
                },
                 {
                    version: "4.2",
                    notes: [
                        { type: 'improvement', text: 'Otimização do layout para se adaptar ao conteúdo, com barra de rolagem principal.' },
                        { type: 'improvement', text: 'Correção na quebra de linha dos CPFs nas tabelas.' },
                    ]
                },
                {
                    version: "4.1",
                    notes: [
                        { type: 'feature', text: 'Modo "Gerar Modelo SOC": Carregue a planilha da empresa para gerar um "Modelo 1" pronto para importação.' },
                        { type: 'improvement', text: 'Detecção de Dados Misturados: Identifica CPFs/Matrículas e Nomes/CPFs conflitantes.' },
                        { type: 'improvement', text: 'Layout de "Novos Funcionários" agora mostra a lista detalhada completa.' },
                         { type: 'improvement', text: 'Nomenclatura dos cabeçalhos de divergência atualizada para maior clareza.' },
                    ]
                },
                {
                    version: "4.0",
                    notes: [
                        { type: 'feature', text: 'Adicionado histórico de atualizações nesta janela.' },
                        { type: 'improvement', text: 'Ajuste no layout para se adaptar ao conteúdo e melhorias na barra de rolagem das tabelas.' },
                    ]
                }
            ];

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className={`w-full max-w-lg rounded-lg shadow-2xl ${theme === 'dark' ? 'bg-gray-800 border border-gray-700' : 'bg-white'}`}>
                        <div className={`p-4 border-b ${theme === 'dark' ? 'border-gray-700' : 'border-gray-200'} flex justify-between items-center`}>
                            <h3 className={`font-bold text-lg ${theme === 'dark' ? 'text-white' : 'text-gray-900'}`}>Novidades da Versão {APP_VERSION}</h3>
                            <button onClick={onClose} className={`${theme === 'dark' ? 'text-gray-400 hover:text-white' : 'text-gray-500 hover:text-gray-800'}`}>&times;</button>
                        </div>
                        <div className="p-6 space-y-4 text-sm max-h-[70vh] overflow-y-auto">
                             <div>
                                <p className="font-semibold text-green-400">Melhorias nesta versão:</p>
                                <ul className="list-disc list-inside space-y-1 mt-2">
                                    <li>**Geração de Modelo SOC Aprimorada:** Agora preenche automaticamente Cod. Funcionário, Nome Setor e Nome Cargo, com formatação inteligente de texto.</li>
                                    <li>**Validação de Dados:** Antes de gerar o modelo, o sistema verifica se dados essenciais estão faltando e informa o usuário.</li>
                                </ul>
                            </div>
                            <hr className={theme === 'dark' ? 'border-gray-600' : 'border-gray-300'} />
                            <div>
                                <h4 className={`font-bold mb-2 ${theme === 'dark' ? 'text-gray-200' : 'text-gray-800'}`}>Histórico de Atualizações</h4>
                                {updateHistory.map(update => (
                                    <div key={update.version} className="mb-4">
                                        <p className={`font-semibold ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}`}>Versão {update.version}</p>
                                        <ul className="list-disc list-inside space-y-1 mt-1 pl-2">
                                            {update.notes.map((note, index) => (
                                                <li key={index}>
                                                    <span className={`font-medium ${note.type === 'feature' ? 'text-blue-400' : 'text-green-400'}`}>{note.type === 'feature' ? 'Funcionalidade: ' : 'Melhoria: '}</span>
                                                    {note.text}
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div className={`p-4 border-t ${theme === 'dark' ? 'border-gray-700' : 'border-gray-200'} text-right`}>
                             <button onClick={onClose} className="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                                Entendido
                            </button>
                        </div>
                    </div>
                </div>
            )
        };
        
        const MissingDataModal = ({ isOpen, onClose, onConfirm, missingData, theme }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className={`w-full max-w-xl rounded-lg shadow-2xl ${theme === 'dark' ? 'bg-gray-800 border border-gray-700' : 'bg-white'}`}>
                        <div className={`p-4 border-b ${theme === 'dark' ? 'border-gray-700' : 'border-gray-200'}`}>
                            <h3 className={`font-bold text-lg ${theme === 'dark' ? 'text-white' : 'text-gray-900'}`}>Dados Obrigatórios Faltando</h3>
                        </div>
                        <div className="p-6 text-sm">
                            <p className={`${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'} mb-4`}>
                                Foram encontrados funcionários com informações essenciais faltando. Você pode cancelar para corrigir a planilha original ou gerar um modelo incompleto.
                            </p>
                            <div className={`border rounded-lg p-2 max-h-64 overflow-y-auto ${theme === 'dark' ? 'border-gray-600' : 'border-gray-300'}`}>
                                {missingData.map(emp => (
                                    <div key={emp.index} className={`p-2 ${theme === 'dark' ? 'hover:bg-gray-700' : 'hover:bg-gray-100'} rounded`}>
                                        <p className={`font-semibold ${theme === 'dark' ? 'text-white' : 'text-black'}`}>Linha {emp.index}: {emp.nome || 'Nome não encontrado'}</p>
                                        <p className="text-red-500 text-xs">Faltando: {emp.missing.join(', ')}</p>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div className={`p-4 border-t ${theme === 'dark' ? 'border-gray-700' : 'border-gray-200'} flex justify-end space-x-4`}>
                             <button onClick={onClose} className={`font-bold py-2 px-4 rounded-lg transition-colors ${theme === 'dark' ? 'bg-gray-600 hover:bg-gray-500 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'}`}>
                                Cancelar
                            </button>
                             <button onClick={onConfirm} className="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                                Gerar Mesmo Assim
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Componente Principal ---
        function App() {
            const [theme, setTheme] = useState('dark');
            const [mode, setMode] = useState('compare');
            const [activeDetail, setActiveDetail] = useState(null);
            const [isChatOpen, setIsChatOpen] = useState(false);
            const [isUpdateModalOpen, setIsUpdateModalOpen] = useState(false);
            const [missingDataError, setMissingDataError] = useState(null);
            const [socFile, setSocFile] = useState(null);
            const [companyFile, setCompanyFile] = useState(null);
            const [socFileInfo, setSocFileInfo] = useState(null);
            const [companyFileInfo, setCompanyFileInfo] = useState(null);
            const [codUnid, setCodUnid] = useState('');
            const [nomeUnidade, setNomeUnidade] = useState('');

            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState(null);
            const [results, setResults] = useState(null);
            const [originalSocData, setOriginalSocData] = useState(null);
            const [dataForIncompleteGeneration, setDataForIncompleteGeneration] = useState(null);


            useEffect(() => {
                const seenVersion = localStorage.getItem('appVersion');
                if (seenVersion !== APP_VERSION) {
                    setIsUpdateModalOpen(true);
                }
            }, []);

            const handleCloseUpdateModal = () => {
                localStorage.setItem('appVersion', APP_VERSION);
                setIsUpdateModalOpen(false);
            };

            useEffect(() => {
                document.body.className = theme === 'dark' ? 'bg-gray-800 text-gray-200' : 'bg-gray-100 text-gray-800';
            }, [theme]);
            
            const toggleTheme = () => {
                setTheme(prevTheme => prevTheme === 'dark' ? 'light' : 'dark');
            };

            const handleDetailToggle = (detail) => {
                setActiveDetail(prevDetail => prevDetail === detail ? null : detail);
            };

            const readAndProcessSheet = (file) => {
                return new Promise((resolve, reject) => {
                    if (!file) {
                        return reject(new Error("Arquivo não fornecido."));
                    }
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = new Uint8Array(event.target.result);
                            const workbook = XLSX.read(data, { type: 'array', cellDates: true });

                            let jsonData = [], headerRow = [], columnMap = {};
                            let foundHeader = false;

                            for (const sheetName of workbook.SheetNames) {
                                const worksheet = workbook.Sheets[sheetName];
                                const dataAsArray = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });
                                if (dataAsArray.length === 0) continue;

                                let headerIndex = -1;
                                const keywords = ['cpf', 'nome', 'nascimento', 'admissão', 'matrícula', 'cargo', 'setor'];
                                for (let i = 0; i < Math.min(dataAsArray.length, 10); i++) {
                                    const rowString = dataAsArray[i].join(' ').toLowerCase();
                                    if (keywords.filter(k => rowString.includes(k)).length >= 3) {
                                        headerIndex = i;
                                        break;
                                    }
                                }

                                if (headerIndex !== -1) {
                                    headerRow = dataAsArray[headerIndex].map(h => String(h).trim());
                                    const dataRows = dataAsArray.slice(headerIndex + 1);
                                    jsonData = dataRows.map(row => {
                                        const obj = {};
                                        headerRow.forEach((key, index) => { if (key) obj[key] = row[index]; });
                                        return obj;
                                    }).filter(obj => Object.values(obj).some(val => val !== ""));
                                    
                                    for (const standardKey in columnMappings) {
                                        const foundHeaderName = headerRow.find(h => columnMappings[standardKey].map(n => n.toLowerCase()).includes(h.toLowerCase()));
                                        if (foundHeaderName) columnMap[standardKey] = foundHeaderName;
                                    }
                                    
                                    foundHeader = true;
                                    break;
                                }
                            }
                            if (!foundHeader) throw new Error("Não foi possível encontrar uma linha de cabeçalho (com colunas como CPF, Nome, etc.).");
                            resolve({ jsonData, headerRow, columnMap });
                        } catch (e) {
                            reject(e);
                        }
                    };
                    reader.onerror = (e) => reject(new Error("Erro ao ler o arquivo: " + e));
                    reader.readAsArrayBuffer(file);
                });
            };

            const handleFileSelect = async (file, fileType) => {
                const setFile = fileType === 'soc' ? setSocFile : setCompanyFile;
                const setInfo = fileType === 'soc' ? setSocFileInfo : setCompanyFileInfo;
                
                setFile(file);
                if (!file) {
                    setInfo(null);
                    return;
                }

                setInfo({ message: 'Lendo...' });
                try {
                    const { jsonData } = await readAndProcessSheet(file);
                    const validData = jsonData.filter(row => getCpfInvalidityReason(findColumnValue(row, columnMappings.cpf)) === null);
                    setInfo({ message: `${validData.length} funcionários` });
                } catch (error) {
                    setInfo({ message: 'Erro ao ler', error: true });
                    console.error(`Erro ao ler o arquivo ${fileType}:`, error);
                }
            };
            
            const handleCompare = useCallback(async () => {
                setActiveDetail(null);
                if (!socFile || !companyFile) {
                    setError({ title: 'Arquivos Faltando', message: 'Por favor, selecione os dois arquivos de planilha para continuar.' });
                    setResults(null);
                    return;
                }
                
                setIsLoading(true);
                setError(null);
                setResults(null);

                try {
                    const socFileData = await readAndProcessSheet(socFile);
                    setOriginalSocData({ raw: socFileData.jsonData, headers: socFileData.headerRow, columnMap: socFileData.columnMap });
                    
                    const companyFileData = await readAndProcessSheet(companyFile);
                    
                    const socData = standardizeData(socFileData.jsonData);
                    const companyData = standardizeData(companyFileData.jsonData);
                    
                    const invalidCpfs = [];
                    const filterValidData = (data, source) => data.filter(row => {
                        const reason = getCpfInvalidityReason(row.cpf);
                        if (reason) {
                            invalidCpfs.push({ name: row.nome || 'Não informado', cpf: normalizeValue(row.cpf) || 'Vazio', source, reason });
                            return false;
                        }
                        return true;
                    });

                    const validSocData = filterValidData(socData, 'Planilha SOC');
                    const validCompanyData = filterValidData(companyData, 'Planilha da Empresa');
                    
                    let discrepancies = [], newEmployees = [], socMap = new Map();
                    
                    // Verificação de duplicados no SOC
                    const socDuplicates = new Map();
                    validSocData.forEach(row => {
                        const cpf = normalizeCpf(row.cpf);
                        if (!socDuplicates.has(cpf)) {
                            socDuplicates.set(cpf, []);
                        }
                        socDuplicates.get(cpf).push(row);
                    });

                    socDuplicates.forEach((group, cpf) => {
                        if (group.length > 1) {
                            const statuses = new Set(group.map(emp => normalizeValue(emp.situacao)));
                            if (statuses.size > 1) {
                                discrepancies.push({
                                    cpf: formatCpf(cpf),
                                    name: group[0].nome,
                                    isInternal: true,
                                    type: 'internalStatusConflict',
                                    details: group.map(emp => ({
                                        codFuncionario: emp.codFuncionario,
                                        situacao: normalizeValue(emp.situacao) || 'Não informada'
                                    }))
                                });
                            }
                        }
                    });

                    validSocData.forEach(row => socMap.set(normalizeCpf(row.cpf), row));

                    validCompanyData.forEach(companyRow => {
                        const companyCpf = normalizeCpf(companyRow.cpf);
                        const socRow = socMap.get(companyCpf);

                        if (socRow) {
                            const employeeDiscrepancies = [];
                            const fieldsToCompare = {
                                'Nome': { soc: socRow.nome, comp: companyRow.nome, normalize: normalizeName },
                                'Data de Nascimento': { soc: socRow.dataNascimento, comp: companyRow.dataNascimento, normalize: normalizeValue },
                                'Data de Admissão': { soc: socRow.dataAdmissao, comp: companyRow.dataAdmissao, normalize: normalizeValue },
                                'Matrícula': { soc: socRow.matricula, comp: companyRow.matricula, normalize: normalizeValue },
                                'Data de Demissão': { soc: socRow.dataDemissao, comp: companyRow.dataDemissao, normalize: normalizeValue }
                            };

                            for (const field in fieldsToCompare) {
                                const { soc, comp, normalize } = fieldsToCompare[field];
                                if (normalize(soc) !== normalize(comp)) {
                                    employeeDiscrepancies.push({ 
                                        field, 
                                        socValue: normalizeValue(soc) || 'Não consta no SOC', 
                                        companyValue: normalizeValue(comp) || 'Não consta na Empresa' 
                                    });
                                }
                            }

                            if (employeeDiscrepancies.length > 0) {
                                discrepancies.push({
                                    cpf: normalizeValue(companyRow.cpf),
                                    name: companyRow.nome || `Funcionário com CPF ${normalizeValue(companyRow.cpf)}`,
                                    matricula: normalizeValue(companyRow.matricula) || 'Não informada',
                                    isInternal: false,
                                    type: 'fieldMismatch',
                                    details: employeeDiscrepancies
                                });
                            }
                            socMap.delete(companyCpf);
                        } else {
                            newEmployees.push(companyRow);
                        }
                    });
                    
                    // Lógica de verificação de mistura de dados
                    const allData = [...validSocData, ...validCompanyData];
                    const matriculaMap = new Map();
                    const nomeMap = new Map();

                    allData.forEach(emp => {
                        const matricula = normalizeValue(emp.matricula);
                        const cpf = normalizeCpf(emp.cpf);
                        const nome = normalizeName(emp.nome);

                        if(matricula) {
                            if (matriculaMap.has(matricula) && matriculaMap.get(matricula).cpf !== cpf) {
                                discrepancies.push({ name: `Matrícula ${matricula} duplicada`, isInternal: true, type: 'mixedData', details: [{ field: 'CPF no SOC', value: matriculaMap.get(matricula).cpf }, { field: 'CPF na Empresa', value: cpf }] });
                            } else if (!matriculaMap.has(matricula)) {
                                matriculaMap.set(matricula, { cpf, nome: emp.nome });
                            }
                        }
                        
                        if(nome) {
                            if (nomeMap.has(nome) && nomeMap.get(nome) !== cpf) {
                                discrepancies.push({ name: `Nome '${emp.nome}' duplicado`, isInternal: true, type: 'mixedData', details: [{ field: 'CPF Anterior', value: nomeMap.get(nome) }, { field: 'CPF Atual', value: cpf }] });
                            } else if (!nomeMap.has(nome)) {
                                nomeMap.set(nome, cpf);
                            }
                        }
                    });


                    const removedEmployees = Array.from(socMap.values()).map(emp => ({
                        ...emp,
                        status: normalizeValue(emp.dataDemissao) 
                            ? `Desligado no SOC (em ${normalizeValue(emp.dataDemissao)}) e não consta na planilha da Empresa` 
                            : 'Ativo no SOC, mas não consta na planilha da Empresa'
                    }));
                    
                    const socActiveCount = validSocData.filter(emp => String(emp.situacao).toUpperCase() === 'S').length;
                    const socInactiveCount = validSocData.length - socActiveCount;

                    setResults({ 
                        discrepancies, 
                        newEmployees, 
                        invalidCpfs, 
                        removedEmployees, 
                        socData: validSocData, 
                        companyData: validCompanyData,
                        socActiveCount,
                        socInactiveCount
                    });

                } catch (e) {
                    console.error("Erro na comparação:", e);
                    setError({ title: `Erro ao Processar Arquivo`, message: e.message, suggestion: "Verifique se o arquivo não está corrompido e se os nomes das colunas estão corretos. Tente salvar a planilha no formato .xlsx." });
                } finally {
                    setIsLoading(false);
                }
            }, [socFile, companyFile]);

            const handleClear = () => {
                setSocFile(null);
                setCompanyFile(null);
                setSocFileInfo(null);
                setCompanyFileInfo(null);
                setResults(null);
                setError(null);
                setIsLoading(false);
                setOriginalSocData(null);
                setActiveDetail(null);
                if (document.getElementById('soc-file')) document.getElementById('soc-file').value = '';
                if(document.getElementById('company-file')) document.getElementById('company-file').value = '';
                if(document.getElementById('company-file-generate')) document.getElementById('company-file-generate').value = '';
            };
            
            const handleExport = () => {
                if (!originalSocData || !results) {
                    alert("Não há dados para exportar.");
                    return;
                }

                let updatedData = JSON.parse(JSON.stringify(originalSocData.raw));
                const { columnMap, headers } = originalSocData;
                
                const situacaoHeader = columnMap.situacao;
                const cpfHeader = columnMap.cpf;

                if (!situacaoHeader || !cpfHeader) {
                    alert("Não foi possível encontrar as colunas 'Situação' ou 'CPF' na planilha SOC para atualizar.");
                    return;
                }
                
                const removedCpfSet = new Set(results.removedEmployees.map(emp => normalizeCpf(emp.cpf)));
                updatedData.forEach(row => {
                    if (removedCpfSet.has(normalizeCpf(row[cpfHeader]))) {
                        row[situacaoHeader] = 'N';
                    }
                });

                results.newEmployees.forEach(newEmp => {
                    const newRow = {};
                    headers.forEach(header => { newRow[header] = ''; });
                    for (const key in columnMap) {
                        if (columnMap[key] && newEmp[key] !== undefined) {
                            newRow[columnMap[key]] = newEmp[key];
                        }
                    }
                    newRow[situacaoHeader] = 'S';
                    updatedData.push(newRow);
                });
                
                const outputData = [
                    ['Modelo 1'],
                    headers, 
                    ...updatedData.map(row => headers.map(header => row[header] || ''))
                ];
                const worksheet = XLSX.utils.aoa_to_sheet(outputData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Funcionários Atualizados");
                XLSX.writeFile(workbook, "Planilha_SOC_Atualizada.xlsx");
            };

            const proceedWithGeneration = (data) => {
                const modelHeaders = ["Cod.Unid","Nome Unidade","Cod.Setor","Nome Setor","Cod.Cargo","Nome Cargo","Matrícula","Cod Funcionário","Nome Funcionário","Dt.Nascimento","Sexo","Situação","Dt.Admissão","Dt.Demissão","Estado Civil","Pis/Pasep","Contratação","Rg","UF-RG","CPF","CTPS","Endereço","Bairro","Cidade","UF","Cep","Tel","Naturalidade","Cor","E-mail","Deficiencia","CBO","GFIP","Endereço Unidade","Bairro Unidade","Cidade Unidade","Estado Unidade","Cep Unidade","CNPJ Unidade","Inscrição Unidade","Tel1 Unidade","Tel2 Unidade","Tel3 Unidade","Tel4 Unidade","Contato Unid","Cnae","Número Endereço Funcionário","Complemento Endereço Funcionário","Razão Social Unid.","Nome da Mae do Funcionário","Cod.Centro Custo","Dt. Ultima Movimentação","Cod. Unidade contratante","Razão Social","CNPJ","Turno","Dt.Emissão.Cart.Prof","Série CTPS","CNAE 2.0","CNAE Livre","Descrição CNAE Livre","CEI","Função","CNAE 7","Tipo de CNAE Utilizado","Descrição Detalhada do Cargo","Nº endereço Unidade","Complemento endereço Unidade","Regime de Revezamento","Orgão Expedidor do RG","Campo Livre 1","Campo Livre 2","Campo Livre 3","Telefone SMS","Grau de Risco","UF CTPS","Nome Centro Custo","Autoriza SMS","Endereço Cobrança Unidade","Número Endereço Cobrança Unidade","Bairro Cobrança Unidade","Cidade Cobrança Unidade","Estado Cobrança Unidade","Cep Cobrança Unidade","Complemento Endereço Cobrança Unidade","Remuneração Mensal (R$)","Telefone Comercial","Telefone Celular","Data Emissão RG","Código do País de Nascimento","Origem Descrição Detalhada","Unidade Contratante","Escolaridade","Código Categoria (eSocial)","Matrícula RH","Gênero","Nome Social","Tipo de Admissão","Grau de Instrução","Nome do Pai do Funcionário","Tipo de Vínculo","Nome do Turno","Campo Livre 4","CPF Unidade","CAEPF Unidade","Tipo Sanguíneo","Dt. Inicio Periodo Aquisitivo","Dt. Fim Periodo Aquisitivo","CNO Unidade","Desconsiderar para o eSocial","Dt. Validade RG","Desconsiderar Unidade para o eSocial"];
                const outputData = [
                    ['Modelo 1'],
                    modelHeaders,
                    ...data.map((emp, index) => {
                        const row = new Array(modelHeaders.length).fill('');
                        row[0] = codUnid;
                        row[1] = nomeUnidade;
                        row[7] = index + 1; // Cod Funcionário
                        row[8] = emp.nome || ''; // Nome Funcionário
                        row[19] = emp.cpf || ''; // CPF
                        row[9] = emp.dataNascimento || ''; // Dt.Nascimento
                        row[12] = emp.dataAdmissao || ''; // Dt.Admissão
                        row[6] = emp.matricula || ''; // Matrícula
                        row[11] = 'S'; // Situação
                        row[3] = formatTitleCase(emp.nomeSetor); // Nome Setor
                        row[5] = formatTitleCase(emp.nomeCargo); // Nome Cargo
                        row[10] = (emp.sexo && emp.sexo.toUpperCase().startsWith('M')) ? 'M' : (emp.sexo && emp.sexo.toUpperCase().startsWith('F')) ? 'F' : ''; // Sexo
                        return row;
                    })
                ];

                const worksheet = XLSX.utils.aoa_to_sheet(outputData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Modelo SOC Gerado");
                XLSX.writeFile(workbook, "Modelo_SOC_Gerado.xlsx");
            };

            const handleGenerateModel = async () => {
                if (!companyFile || !codUnid || !nomeUnidade) {
                    setError({ title: 'Dados Faltando', message: 'Por favor, preencha o Código e Nome da Unidade e selecione a planilha da empresa.' });
                    return;
                }
                setIsLoading(true);
                setError(null);
                try {
                    const { jsonData } = await readAndProcessSheet(companyFile);
                    const standardizedData = standardizeData(jsonData);

                    const requiredFields = ['nome', 'cpf', 'dataNascimento', 'dataAdmissao', 'matricula', 'nomeCargo', 'nomeSetor'];
                    const employeesWithMissingData = standardizedData.map((emp, index) => {
                        const missing = requiredFields.filter(field => !emp[field]);
                        return { ...emp, missing, index: index + 1 };
                    }).filter(emp => emp.missing.length > 0);

                    if (employeesWithMissingData.length > 0) {
                        setDataForIncompleteGeneration(standardizedData);
                        setMissingDataError(employeesWithMissingData);
                    } else {
                        proceedWithGeneration(standardizedData);
                    }
                } catch (e) {
                     setError({ title: `Erro ao Gerar Modelo`, message: e.message, suggestion: "Verifique o arquivo da empresa e tente novamente." });
                } finally {
                    setIsLoading(false);
                }
            };

            const EmployeeList = ({ employees, theme }) => (
                <div className="overflow-auto max-h-96">
                    <table className="w-full text-sm text-left">
                        <thead className={`${theme === 'dark' ? 'bg-gray-600 text-gray-300' : 'bg-gray-50 text-gray-700'} text-xs uppercase sticky top-0`}>
                            <tr>
                                <th className="px-2 py-2 w-12 text-center">#</th>
                                <th className="px-4 py-2">Nome</th>
                                <th className="px-4 py-2">CPF</th>
                                <th className="px-4 py-2">Nascimento</th>
                                <th className="px-4 py-2">Admissão</th>
                                <th className="px-4 py-2">Matrícula</th>
                            </tr>
                        </thead>
                        <tbody>
                            {employees.map((item, i) => (
                                <tr key={i} className={`border-b ${theme === 'dark' ? 'border-gray-600' : 'border-gray-200'}`}>
                                    <td className="px-2 py-2 text-center">{i + 1}</td>
                                    <td className="px-4 py-2">{item.nome || 'Não consta'}</td>
                                    <td className="px-4 py-2 font-mono whitespace-nowrap">{formatCpf(item.cpf) || 'Não consta'}</td>
                                    <td className="px-4 py-2">{normalizeValue(item.dataNascimento) || 'Não consta'}</td>
                                    <td className="px-4 py-2">{normalizeValue(item.dataAdmissao) || 'Não consta'}</td>
                                    <td className="px-4 py-2">{normalizeValue(item.matricula) || 'Não consta'}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
            
            const renderDetailView = () => {
                if (!results) return null;

                const detailContent = {
                    socEmployees: <EmployeeList employees={results.socData} theme={theme} />,
                    companyEmployees: <EmployeeList employees={results.companyData} theme={theme} />,
                    discrepancies: (
                        <div className="space-y-4 max-h-96 overflow-auto">
                            {results.discrepancies.map((item, i) => (
                                <div key={i} className={`${theme === 'dark' ? 'bg-gray-800 border-gray-600' : 'bg-white border-gray-200'} border rounded-lg p-4`}>
                                    <p className={`font-bold ${theme === 'dark' ? 'text-white' : 'text-gray-900'}`}>{item.name}</p>
                                    <div className={`flex flex-wrap gap-x-4 text-xs ${theme === 'dark' ? 'text-gray-400' : 'text-gray-500'} mb-2`}><span><strong>CPF:</strong> {formatCpf(item.cpf)}</span>{ !item.isInternal && <span><strong>Matrícula:</strong> {item.matricula}</span>}</div>
                                    {item.type === 'internalStatusConflict' ? (
                                        <table className="w-full text-xs text-left mt-2 table-fixed">
                                            <thead className={`${theme === 'dark' ? 'bg-gray-600 text-gray-300' : 'bg-gray-100 text-gray-700'}`}><tr><th className="px-3 py-1 w-1/2">Cod Funcionário</th><th className="px-3 py-1 w-1/2">Situação no SOC</th></tr></thead>
                                            <tbody>{item.details.map((d, j) => <tr key={j} className={`border-b ${theme === 'dark' ? 'border-gray-700' : 'border-gray-200'} last:border-b-0`}><td className={`px-3 py-1 ${theme === 'dark' ? 'bg-red-900/40 text-red-300' : 'bg-red-50 text-red-700'}`}>{d.codFuncionario}</td><td className={`px-3 py-1 ${theme === 'dark' ? 'bg-red-900/40 text-red-300' : 'bg-red-50 text-red-700'}`}>{d.situacao}</td></tr>)}</tbody>
                                        </table>
                                    ) : item.type === 'mixedData' ? (
                                        <table className="w-full text-xs text-left mt-2 table-fixed">
                                             <thead className={`${theme === 'dark' ? 'bg-gray-600 text-gray-300' : 'bg-gray-100 text-gray-700'}`}><tr><th className="px-3 py-1 w-1/2">Dado</th><th className="px-3 py-1 w-1/2">Valor Encontrado</th></tr></thead>
                                             <tbody>{item.details.map((d, j) => <tr key={j} className={`border-b ${theme === 'dark' ? 'border-gray-700' : 'border-gray-200'} last:border-b-0`}><td className="px-3 py-1 font-medium">{d.field}</td><td className={`px-3 py-1 ${theme === 'dark' ? 'bg-red-900/40 text-red-300' : 'bg-red-50 text-red-700'}`}>{d.value}</td></tr>)}</tbody>
                                        </table>
                                    ) : (
                                        <table className="w-full text-xs text-left mt-2 table-fixed">
                                            <thead className={`${theme === 'dark' ? 'bg-gray-600 text-gray-300' : 'bg-gray-100 text-gray-700'}`}><tr><th className="px-3 py-1 w-[30%]">Campo</th><th className="px-3 py-1 w-[35%]">Informação no SOC</th><th className="px-3 py-1 w-[35%]">Informação na Planilha da Empresa</th></tr></thead>
                                            <tbody>{item.details.map((d, j) => <tr key={j} className={`border-b ${theme === 'dark' ? 'border-gray-700' : 'border-gray-200'} last:border-b-0`}><td className="px-3 py-1 font-medium">{d.field}</td><td className={`px-3 py-1 ${theme === 'dark' ? 'bg-red-900/40 text-red-300' : 'bg-red-50 text-red-700'}`}>{d.socValue}</td><td className={`px-3 py-1 ${theme === 'dark' ? 'bg-red-900/40 text-red-300' : 'bg-red-50 text-red-700'}`}>{d.companyValue}</td></tr>)}</tbody>
                                        </table>
                                    )}
                                </div>
                            ))}
                        </div>
                    ),
                    newEmployees: (
                        <EmployeeList employees={results.newEmployees} theme={theme} />
                    ),
                    removedEmployees: (
                         <div className="space-y-2">
                            {results.removedEmployees.map((item, i) => (
                                <div key={i} className={`p-4 border ${theme === 'dark' ? 'border-gray-600' : 'border-gray-200'} rounded-lg`}>
                                    <p className={`font-semibold ${theme === 'dark' ? 'text-white' : 'text-gray-800'}`}>{item.nome || 'Não informado'}</p>
                                    <p className={`text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'} font-mono`}>{formatCpf(item.cpf)}</p>
                                    <p className={`text-sm ${theme === 'dark' ? 'text-red-400' : 'text-red-600'} mt-1`}>{item.status}</p>
                                </div>
                            ))}
                        </div>
                    ),
                    invalidCpfs: (
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className={`${theme === 'dark' ? 'bg-gray-600 text-gray-300' : 'bg-gray-50 text-gray-700'} text-xs uppercase`}><tr><th className="px-4 py-2">Nome</th><th className="px-4 py-2">CPF Informado</th><th className="px-4 py-2">Motivo</th><th className="px-4 py-2">Origem</th></tr></thead>
                                <tbody>{results.invalidCpfs.map((item, i) => <tr key={i} className={`border-b ${theme === 'dark' ? 'border-gray-600' : 'border-gray-200'}`}><td className="px-4 py-2">{item.name}</td><td className={`px-4 py-2 font-mono whitespace-nowrap ${theme === 'dark' ? 'text-red-400' : 'text-red-600'}`}>{formatCpf(item.cpf)}</td><td className="px-4 py-2">{item.reason}</td><td className="px-4 py-2">{item.source}</td></tr>)}</tbody>
                            </table>
                        </div>
                    )
                };

                return (
                    <div className={`detail-view ${activeDetail ? 'open' : ''}`}>
                        <div className="p-4 mt-4 border-t border-gray-500/50">
                            {detailContent[activeDetail]}
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen flex flex-col items-center p-4">
                    <main className={`relative ${theme === 'dark' ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-200'} rounded-2xl shadow-xl p-6 md:p-10 w-full max-w-6xl border`}>
                        <button onClick={() => setIsChatOpen(true)} className={`absolute top-4 left-4 p-2 rounded-lg text-sm font-semibold ${theme === 'dark' ? 'bg-gray-600 text-gray-200 hover:bg-gray-500' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'} transition-colors`}>
                            Ajuda IA
                        </button>
                        <button onClick={toggleTheme} className="absolute top-4 right-4 p-2 rounded-full bg-gray-500/20 hover:bg-gray-500/40 transition-colors">
                            <ThemeToggleIcon theme={theme} />
                        </button>
                        
                        <Header theme={theme} />

                        <div className={`flex justify-center mb-8 p-1 rounded-lg ${theme === 'dark' ? 'bg-gray-800' : 'bg-gray-200'}`}>
                            <button onClick={() => setMode('compare')} className={`w-1/2 py-2 rounded-md font-semibold transition-colors ${mode === 'compare' ? 'bg-blue-600 text-white' : (theme === 'dark' ? 'hover:bg-gray-700' : 'hover:bg-gray-300')}`}>Comparar Planilhas</button>
                            <button onClick={() => setMode('generate')} className={`w-1/2 py-2 rounded-md font-semibold transition-colors ${mode === 'generate' ? 'bg-blue-600 text-white' : (theme === 'dark' ? 'hover:bg-gray-700' : 'hover:bg-gray-300')}`}>Gerar Modelo SOC</button>
                        </div>
                        
                        {mode === 'compare' ? (
                            <>
                                <Notice theme={theme} />
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                    <FileInput id="soc-file" label="1. Planilha Modelo SOC" onFileSelect={(file) => handleFileSelect(file, 'soc')} fileInfo={socFileInfo} theme={theme} />
                                    <FileInput id="company-file" label="2. Planilha Recente da Empresa" onFileSelect={(file) => handleFileSelect(file, 'company')} fileInfo={companyFileInfo} theme={theme} />
                                </div>
                                <div className="text-center">
                                    <button onClick={handleCompare} disabled={isLoading} className="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 disabled:bg-gray-500">
                                        {isLoading ? 'Analisando...' : 'Verificar Dados'}
                                    </button>
                                </div>
                            </>
                        ) : (
                             <>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                     <div>
                                        <label htmlFor="codUnid" className={`block text-sm font-medium ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'} mb-2`}>1. Código da Unidade</label>
                                        <input id="codUnid" type="text" value={codUnid} onChange={(e) => setCodUnid(e.target.value)} className={`w-full p-2 rounded-lg border ${theme === 'dark' ? 'bg-gray-600 border-gray-500' : 'bg-white border-gray-300'}`} />
                                     </div>
                                      <div>
                                        <label htmlFor="nomeUnidade" className={`block text-sm font-medium ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'} mb-2`}>2. Nome da Unidade</label>
                                        <input id="nomeUnidade" type="text" value={nomeUnidade} onChange={(e) => setNomeUnidade(e.target.value)} className={`w-full p-2 rounded-lg border ${theme === 'dark' ? 'bg-gray-600 border-gray-500' : 'bg-white border-gray-300'}`} />
                                     </div>
                                </div>
                                <div className="mb-8">
                                    <FileInput id="company-file-generate" label="3. Planilha da Empresa" onFileSelect={(file) => handleFileSelect(file, 'company')} fileInfo={companyFileInfo} theme={theme} />
                                </div>
                                <div className="text-center">
                                    <button onClick={handleGenerateModel} disabled={isLoading} className="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 disabled:bg-gray-500">
                                        {isLoading ? 'Gerando...' : 'Gerar Modelo SOC'}
                                    </button>
                                </div>
                            </>
                        )}


                        <div className="mt-10">
                            {isLoading && <Loader text="Analisando dados..." theme={theme} />}
                            {error && (
                                <div className={`${theme === 'dark' ? 'bg-red-900/50 border-red-700 text-red-300' : 'bg-red-100 border-red-500 text-red-700'} border p-4 rounded-lg`} role="alert">
                                    <p className="font-bold">{error.title}</p>
                                    <p>{error.message}</p>
                                    {error.suggestion && <p className="mt-2 text-sm"><strong>Sugestão:</strong> {error.suggestion}</p>}
                                </div>
                            )}
                            {results && mode === 'compare' && (
                                <div>
                                    <div className="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8">
                                        <StatusSummaryCard active={results.socActiveCount} inactive={results.socInactiveCount} label="Funcionários no SOC" theme={theme} onClick={() => handleDetailToggle('socEmployees')} isActive={activeDetail === 'socEmployees'} />
                                        <SummaryCard value={results.companyData.length} label="Funcionários na Empresa" color="green" theme={theme} onClick={() => handleDetailToggle('companyEmployees')} isActive={activeDetail === 'companyEmployees'} />
                                        <SummaryCard value={results.discrepancies.length} label="Divergências" color="red" theme={theme} onClick={() => handleDetailToggle('discrepancies')} isActive={activeDetail === 'discrepancies'} />
                                        <SummaryCard value={results.newEmployees.length} label="Novos Funcionários" color="green" theme={theme} onClick={() => handleDetailToggle('newEmployees')} isActive={activeDetail === 'newEmployees'} />
                                        <SummaryCard value={results.removedEmployees.length} label="Situação de Funcionário" color="purple" theme={theme} onClick={() => handleDetailToggle('removedEmployees')} isActive={activeDetail === 'removedEmployees'} />
                                        <SummaryCard value={results.invalidCpfs.length} label="CPFs Inválidos" color="yellow" theme={theme} onClick={() => handleDetailToggle('invalidCpfs')} isActive={activeDetail === 'invalidCpfs'} />
                                    </div>
                                    
                                    {renderDetailView()}

                                    <div className="mt-8 text-center space-y-2 md:space-y-0 md:space-x-4">
                                        <button onClick={handleExport} className="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition-colors duration-300 w-full md:w-auto inline-flex items-center justify-center">
                                            Exportar Planilha SOC Atualizada
                                        </button>
                                        <button onClick={handleClear} className="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition-colors duration-300 w-full md:w-auto inline-flex items-center justify-center">
                                            <TrashIcon />
                                            Limpar
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>
                    <footer className={`text-center text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-gray-500'} mt-8 py-4`}>
                        <p>Versão 4.8 (React) | Em caso de erro, reportar para robsonmorais@produtiva.srv.br</p>
                    </footer>
                    <ChatModal isOpen={isChatOpen} onClose={() => setIsChatOpen(false)} theme={theme} />
                    <UpdateNotesModal isOpen={isUpdateModalOpen} onClose={handleCloseUpdateModal} theme={theme} />
                    <MissingDataModal 
                        isOpen={!!missingDataError} 
                        onClose={() => setMissingDataError(null)}
                        onConfirm={() => {
                            proceedWithGeneration(dataForIncompleteGeneration);
                            setMissingDataError(null);
                        }}
                        missingData={missingDataError}
                        theme={theme}
                    />
                </div>
            );
        }
        
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>
